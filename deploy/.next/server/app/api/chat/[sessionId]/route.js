"use strict";(()=>{var e={};e.id=6277,e.ids=[6277,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},55163:(e,a,r)=>{r.r(a),r.d(a,{originalPathname:()=>D,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var t={};r.r(t),r.d(t,{DELETE:()=>y,GET:()=>m,PATCH:()=>h,POST:()=>p,dynamic:()=>l});var s=r(49303),n=r(88716),o=r(60670),i=r(87070),c=r(72331),u=r(90455),d=r(76876);let l="force-dynamic";async function m(e,{params:a}){try{let{sessionId:r}=a,{searchParams:t}=new URL(e.url),s=t.get("after"),n=await c.prisma.chatSession.findUnique({where:{sessionId:r}});if(!n)return i.NextResponse.json({messages:[]});let o={sessionId:n.id};s&&(o.createdAt={gt:new Date(s)});let u=await c.prisma.chatMessage.findMany({where:o,orderBy:{createdAt:"asc"}});return i.NextResponse.json({messages:u})}catch(e){return console.error("Get messages error:",e),i.NextResponse.json({messages:[],error:"Database not ready"})}}async function p(e,{params:a}){try{let{sessionId:r}=a,{message:t,senderType:s,senderName:n,customerEmail:o}=await e.json(),l=null,m=n,p=e.cookies.get("token")?.value;if(p)try{let e=await (0,u.verifyToken)(p);if(e?.userId&&(l=e.userId,"customer"===s)){let a=await c.prisma.user.findUnique({where:{id:e.userId},select:{name:!0}});a?.name&&(m=a.name)}}catch{}let h=await c.prisma.chatSession.findUnique({where:{sessionId:r}});h?"customer"===s&&m&&"Guest"!==m&&await c.prisma.chatSession.update({where:{id:h.id},data:{customerName:m,customerEmail:o||h.customerEmail}}):h=await c.prisma.chatSession.create({data:{sessionId:r,userId:l,customerName:m||"Guest",customerEmail:o||null,status:"active"}});let y=await c.prisma.chatMessage.create({data:{sessionId:h.id,senderType:s,senderId:l,senderName:m||("admin"===s?"Support":"Guest"),message:t,isRead:!1}});if(await c.prisma.chatSession.update({where:{id:h.id},data:{updatedAt:new Date}}),console.log(`[CHAT] Session:${r.substring(0,10)}... | ${s} (${m}): ${t}`),"customer"===s)try{await (0,d.A5)(m||"Guest",r)}catch(e){console.log("Notification error (non-blocking):",e)}return i.NextResponse.json({message:y})}catch(e){return console.error("Send message error:",e),i.NextResponse.json({error:"Database error"},{status:500})}}async function h(e,{params:a}){try{let{sessionId:r}=a,{markAsRead:t,senderType:s}=await e.json();if(t){let e=await c.prisma.chatSession.findUnique({where:{sessionId:r}});e&&await c.prisma.chatMessage.updateMany({where:{sessionId:e.id,senderType:"admin"===s?"customer":"admin",isRead:!1},data:{isRead:!0}})}return i.NextResponse.json({success:!0})}catch(e){return console.error("Mark read error:",e),i.NextResponse.json({success:!1})}}async function y(e,{params:a}){try{let r=e.cookies.get("token")?.value;if(!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,u.verifyToken)(r);if(!t||"admin"!==t.role&&"superadmin"!==t.role)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{sessionId:s}=a;return await c.prisma.chatMessage.create({data:{sessionId:s,senderType:"system",senderId:t.userId,senderName:"Support",message:"Thank you for contacting us! This chat session has been closed. If you have any more questions, feel free to start a new chat. Have a great day! \uD83D\uDC4B",isRead:!1}}),await c.prisma.chatSession.update({where:{sessionId:s},data:{status:"closed"}}),console.log(`[CHAT] Session ${s.substring(0,10)}... closed by admin with bye message`),i.NextResponse.json({success:!0,message:"Session closed"})}catch(e){return console.error("Close session error:",e),i.NextResponse.json({error:"Failed to close session"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/chat/[sessionId]/route",pathname:"/api/chat/[sessionId]",filename:"route",bundlePath:"app/api/chat/[sessionId]/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\chat\\[sessionId]\\route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:w,staticGenerationAsyncStorage:g,serverHooks:x}=f,D="/api/chat/[sessionId]/route";function v(){return(0,o.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}},90455:(e,a,r)=>{r.d(a,{Gv:()=>c,RA:()=>l,V3:()=>u,c_:()=>i,verifyToken:()=>d});var t=r(98691),s=r(6091),n=r(6176);r(71615);let o=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function i(e){return t.ZP.hash(e,10)}async function c(e,a){return t.ZP.compare(e,a)}async function u(e){return new s.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(o)}async function d(e){try{return(await (0,n._)(e,o)).payload}catch(e){return null}}async function l(e){try{let a=e.cookies.get("token")?.value;if(!a)return null;let t=await d(a);if(!t)return null;let{prisma:s}=await r.e(7356).then(r.bind(r,72331)),n=await s.user.findUnique({where:{id:t.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!n||!1===n.isActive)return null;return{id:n.id,userId:n.id,email:n.email,name:n.name,role:n.role,permissions:n.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},76876:(e,a,r)=>{r.d(a,{A5:()=>h,Eb:()=>f,En:()=>l,KY:()=>w,NF:()=>u,Yp:()=>c,an:()=>i,f_:()=>g,ko:()=>m,oX:()=>y,rB:()=>p,r_:()=>o,wN:()=>d});var t=r(72331);async function s(e,a,r,s,n){try{return await t.prisma.notification.create({data:{userId:e,type:a,title:r,message:s,link:n||null}}),!0}catch(e){return console.error("Failed to create notification:",e),!1}}async function n(e,a,r,s){try{let n=await t.prisma.user.findMany({where:{role:{in:["admin","superadmin"]}},select:{id:!0}});return await Promise.all(n.map(n=>t.prisma.notification.create({data:{userId:n.id,type:e,title:a,message:r,link:s||null}}))),!0}catch(e){return console.error("Failed to notify admins:",e),!1}}async function o(e,a,r){await n("order","\uD83D\uDED2 New Order Received!",`${a} placed an order (৳${r.toLocaleString()})`,"/admin/orders")}async function i(e,a){await s(e,"order","✅ Order Confirmed!","Your order has been confirmed and is being processed.","/dashboard/orders")}async function c(e,a,r){await s(e,"order","\uD83D\uDCE6 Order Shipped!",`Your order is on the way!${r?` Tracking: ${r}`:""}`,"/dashboard/orders")}async function u(e,a){await s(e,"order","\uD83C\uDF89 Order Delivered!","Your order has been delivered. Thank you for shopping with us!","/dashboard/orders")}async function d(e,a,r){await s(e,"order","❌ Order Cancelled",r||"Your order has been cancelled.","/dashboard/orders")}async function l(e,a){await s(e,"welcome","\uD83C\uDF89 Welcome to CTG Collection!",`Hi ${a}, thank you for joining us! Explore our amazing products.`,"/shop")}async function m(e,a){await n("user","\uD83D\uDC64 New User Registered!",`${e} (${a}) just joined.`,"/admin/customers")}async function p(e,a){await n("message","\uD83D\uDCE7 New Contact Message!",`${e}: "${a}"`,"/admin/messages")}async function h(e,a){await n("chat","\uD83D\uDCAC New Chat Message!",`${e} sent a message`,"/admin/chat")}async function y(e,a,r){let t={customer:"Customer",seller:"Seller",admin:"Admin",superadmin:"Super Admin"}[r]||r,n=["admin","seller","superadmin"].includes(r)&&"customer"===a;await s(e,"account",n?"\uD83C\uDF8A Congratulations! Role Upgraded":"\uD83D\uDCCB Account Role Updated",n?`You have been promoted to ${t}! Welcome to the team.`:`Your account role has been changed to ${t}.`,"/dashboard")}async function f(e,a){await s(e,"loyalty","\uD83C\uDFC6 Membership Tier Updated!",`Congratulations! You are now a ${a} member. Enjoy exclusive benefits!`,"/dashboard/loyalty")}async function w(e){await s(e,"account","⚠️ Account Deactivated","Your account has been temporarily deactivated. Please contact support for assistance.",void 0)}async function g(e){await s(e,"account","✅ Account Reactivated","Great news! Your account has been reactivated. Welcome back!","/dashboard")}},72331:(e,a,r)=>{r.d(a,{prisma:()=>n});var t=r(53524);let s=globalThis,n=s.prisma??new t.PrismaClient({log:["error"]});s.prisma=n}};var a=require("../../../../webpack-runtime.js");a.C(e);var r=e=>a(a.s=e),t=a.X(0,[8948,5972,8691,8840],()=>r(55163));module.exports=t})();