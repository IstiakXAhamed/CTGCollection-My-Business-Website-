"use strict";(()=>{var e={};e.id=3002,e.ids=[3002,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},81959:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>C,patchFetch:()=>q,requestAsyncStorage:()=>x,routeModule:()=>w,serverHooks:()=>b,staticGenerationAsyncStorage:()=>v});var i={};a.r(i),a.d(i,{POST:()=>h,dynamic:()=>g});var t=a(49303),o=a(88716),s=a(60670),n=a(87070),d=a(72331),c=a(90455),u=a(30971),l=a(30307),m=a(76876),p=a(36119),f=a(84770),y=a.n(f);let g="force-dynamic";async function h(e){try{let r=await e.json(),{referralCode:a}=r,i=u.gY.parse(r),t=i.email.toLowerCase().trim();if(await d.prisma.user.findUnique({where:{email:t}}))return n.NextResponse.json({message:"Email already registered"},{status:400});let o=await d.prisma.user.count(),s=0===o,f=await (0,c.c_)(i.password),g=y().randomBytes(4).toString("hex").toUpperCase(),h=null,w=0,x=0;if(a&&!s){let e=await d.prisma.user.findUnique({where:{referralCode:a.toString()}});if(e){h=e.id;let r=await d.prisma.loyaltySettings.findFirst();r&&r.isEnabled&&(w=r.referralBonusReferred,x=r.referralBonusReferrer)}}let v=await d.prisma.user.create({data:{name:i.name,email:t,password:f,phone:i.phone||null,role:s?"superadmin":"customer",emailVerified:s,referralCode:g},select:{id:!0,name:!0,email:!0,role:!0,emailVerified:!0}});if(h&&(w>0||x>0))try{if(await d.prisma.referral.create({data:{referrerId:h,referredId:v.id,referralCode:a.toString(),status:"completed",referrerBonus:x,referredBonus:w}}),w>0&&(await d.prisma.loyaltyPoints.upsert({where:{userId:v.id},create:{userId:v.id,totalPoints:w,lifetimePoints:w},update:{totalPoints:{increment:w},lifetimePoints:{increment:w}}}),await d.prisma.pointsTransaction.create({data:{userId:v.id,loyaltyId:(await d.prisma.loyaltyPoints.findUnique({where:{userId:v.id}})).id,type:"referral",points:w,description:"Welcome bonus for using referral code"}}),await (0,p.sendLoyaltyUpdateEmail)(v.email,{customerName:v.name,type:"Referral Bonus",points:w,message:"Welcome bonus added to your wallet!"})),x>0){await d.prisma.loyaltyPoints.upsert({where:{userId:h},create:{userId:h,totalPoints:x,lifetimePoints:x},update:{totalPoints:{increment:x},lifetimePoints:{increment:x}}});let e=await d.prisma.loyaltyPoints.findUnique({where:{userId:h}});if(e){await d.prisma.pointsTransaction.create({data:{userId:h,loyaltyId:e.id,type:"referral",points:x,description:`Bonus for referring ${v.name}`}});let r=await d.prisma.user.findUnique({where:{id:h}});r&&await (0,p.sendLoyaltyUpdateEmail)(r.email,{customerName:r.name,type:"Referral Bonus",points:x,message:`You referred ${v.name}!`})}}}catch(e){console.error("Referral processing error:",e)}if(!s){let e=await (0,l.D_)(v.email,"email_verify",v.id);await (0,l.zk)(v.email,e,"email_verify")}try{await (0,m.En)(v.id,v.name),await (0,m.ko)(v.name,v.email)}catch(e){console.log("Notification error (non-blocking):",e)}return n.NextResponse.json({message:s?"Superadmin account created successfully! You are the main administrator.":"Registration successful! Please check your email for verification code.",user:v,isFirstUser:s,requiresVerification:!s},{status:201})}catch(e){if(console.error("Registration error:",e),"ZodError"===e.name)return n.NextResponse.json({message:"Invalid input data",errors:e.errors},{status:400});return n.NextResponse.json({message:"Registration failed"},{status:500})}}let w=new t.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\auth\\register\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:x,staticGenerationAsyncStorage:v,serverHooks:b}=w,C="/api/auth/register/route";function q(){return(0,s.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:v})}},90455:(e,r,a)=>{a.d(r,{Gv:()=>d,RA:()=>l,V3:()=>c,c_:()=>n,verifyToken:()=>u});var i=a(98691),t=a(6091),o=a(6176);a(71615);let s=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function n(e){return i.ZP.hash(e,10)}async function d(e,r){return i.ZP.compare(e,r)}async function c(e){return new t.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(s)}async function u(e){try{return(await (0,o._)(e,s)).payload}catch(e){return null}}async function l(e){try{let r=e.cookies.get("token")?.value;if(!r)return null;let i=await u(r);if(!i)return null;let{prisma:t}=await a.e(7356).then(a.bind(a,72331)),o=await t.user.findUnique({where:{id:i.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!o||!1===o.isActive)return null;return{id:o.id,userId:o.id,email:o.email,name:o.name,role:o.role,permissions:o.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},76876:(e,r,a)=>{a.d(r,{A5:()=>f,Eb:()=>g,En:()=>l,KY:()=>h,NF:()=>c,Yp:()=>d,an:()=>n,f_:()=>w,ko:()=>m,oX:()=>y,rB:()=>p,r_:()=>s,wN:()=>u});var i=a(72331);async function t(e,r,a,t,o){try{return await i.prisma.notification.create({data:{userId:e,type:r,title:a,message:t,link:o||null}}),!0}catch(e){return console.error("Failed to create notification:",e),!1}}async function o(e,r,a,t){try{let o=await i.prisma.user.findMany({where:{role:{in:["admin","superadmin"]}},select:{id:!0}});return await Promise.all(o.map(o=>i.prisma.notification.create({data:{userId:o.id,type:e,title:r,message:a,link:t||null}}))),!0}catch(e){return console.error("Failed to notify admins:",e),!1}}async function s(e,r,a){await o("order","\uD83D\uDED2 New Order Received!",`${r} placed an order (‡ß≥${a.toLocaleString()})`,"/admin/orders")}async function n(e,r){await t(e,"order","‚úÖ Order Confirmed!","Your order has been confirmed and is being processed.","/dashboard/orders")}async function d(e,r,a){await t(e,"order","\uD83D\uDCE6 Order Shipped!",`Your order is on the way!${a?` Tracking: ${a}`:""}`,"/dashboard/orders")}async function c(e,r){await t(e,"order","\uD83C\uDF89 Order Delivered!","Your order has been delivered. Thank you for shopping with us!","/dashboard/orders")}async function u(e,r,a){await t(e,"order","‚ùå Order Cancelled",a||"Your order has been cancelled.","/dashboard/orders")}async function l(e,r){await t(e,"welcome","\uD83C\uDF89 Welcome to CTG Collection!",`Hi ${r}, thank you for joining us! Explore our amazing products.`,"/shop")}async function m(e,r){await o("user","\uD83D\uDC64 New User Registered!",`${e} (${r}) just joined.`,"/admin/customers")}async function p(e,r){await o("message","\uD83D\uDCE7 New Contact Message!",`${e}: "${r}"`,"/admin/messages")}async function f(e,r){await o("chat","\uD83D\uDCAC New Chat Message!",`${e} sent a message`,"/admin/chat")}async function y(e,r,a){let i={customer:"Customer",seller:"Seller",admin:"Admin",superadmin:"Super Admin"}[a]||a,o=["admin","seller","superadmin"].includes(a)&&"customer"===r;await t(e,"account",o?"\uD83C\uDF8A Congratulations! Role Upgraded":"\uD83D\uDCCB Account Role Updated",o?`You have been promoted to ${i}! Welcome to the team.`:`Your account role has been changed to ${i}.`,"/dashboard")}async function g(e,r){await t(e,"loyalty","\uD83C\uDFC6 Membership Tier Updated!",`Congratulations! You are now a ${r} member. Enjoy exclusive benefits!`,"/dashboard/loyalty")}async function h(e){await t(e,"account","‚ö†Ô∏è Account Deactivated","Your account has been temporarily deactivated. Please contact support for assistance.",void 0)}async function w(e){await t(e,"account","‚úÖ Account Reactivated","Great news! Your account has been reactivated. Welcome back!","/dashboard")}},72331:(e,r,a)=>{a.d(r,{prisma:()=>o});var i=a(53524);let t=globalThis,o=t.prisma??new i.PrismaClient({log:["error"]});t.prisma=o},30971:(e,r,a)=>{a.d(r,{dm:()=>o,gY:()=>t});var i=a(21067);let t=i.Ry({name:i.Z_().min(2,"Name must be at least 2 characters"),email:i.Z_().email("Invalid email address"),password:i.Z_().min(6,"Password must be at least 6 characters"),phone:i.Z_().optional()}),o=i.Ry({email:i.Z_().email("Invalid email address"),password:i.Z_().min(1,"Password is required")});i.Ry({name:i.Z_().min(2,"Name is required"),phone:i.Z_().min(11,"Valid phone number is required"),address:i.Z_().min(10,"Address is required"),city:i.Z_().min(2,"City is required"),district:i.Z_().min(2,"District is required"),postalCode:i.Z_().optional(),isDefault:i.O7().optional()}),i.Ry({name:i.Z_().min(3,"Product name is required"),description:i.Z_().min(10,"Description must be at least 10 characters"),categoryId:i.Z_().min(1,"Category is required"),basePrice:i.Rx().positive("Price must be positive"),salePrice:i.Rx().optional(),images:i.IX(i.Z_()).min(1,"At least one image is required"),isFeatured:i.O7().optional(),isBestseller:i.O7().optional()}),i.Ry({name:i.Z_().min(2,"Category name is required"),description:i.Z_().optional(),image:i.Z_().optional(),parentId:i.Z_().optional()}),i.Ry({code:i.Z_().min(3,"Coupon code is required").toUpperCase(),description:i.Z_().optional(),discountType:i.Km(["percentage","fixed"]),discountValue:i.Rx().positive("Discount value must be positive"),minOrderValue:i.Rx().optional(),maxDiscount:i.Rx().optional(),validFrom:i.hT(),validUntil:i.hT(),usageLimit:i.Rx().optional()}),i.Ry({productId:i.Z_().min(1,"Product ID is required"),rating:i.Rx().min(1).max(5,"Rating must be between 1 and 5"),comment:i.Z_().min(10,"Review must be at least 10 characters").optional()})},30307:(e,r,a)=>{a.d(r,{D_:()=>o,VP:()=>s,zk:()=>n});var i=a(72331),t=a(36119);async function o(e,r,a){await i.prisma.verificationCode.deleteMany({where:{email:e,type:r}});let t=Math.floor(1e5+9e5*Math.random()).toString(),o=new Date(Date.now()+3e5);return await i.prisma.verificationCode.create({data:{code:t,type:r,email:e,userId:a,expiresAt:o}}),t}async function s(e,r,a){let t=await i.prisma.verificationCode.findFirst({where:{email:e,type:a,used:!1},orderBy:{createdAt:"desc"}});return t?new Date>t.expiresAt?(await i.prisma.verificationCode.delete({where:{id:t.id}}),{success:!1,message:"Verification code expired. Please request a new code."}):t.attempts>=5?(await i.prisma.verificationCode.delete({where:{id:t.id}}),{success:!1,message:"Too many failed attempts. Please request a new code."}):t.code!==r?(await i.prisma.verificationCode.update({where:{id:t.id},data:{attempts:{increment:1}}}),{success:!1,message:`Invalid code. ${4-t.attempts} attempts remaining.`}):(await i.prisma.verificationCode.update({where:{id:t.id},data:{used:!0}}),{success:!0,message:"Code verified successfully",userId:t.userId||void 0}):{success:!1,message:"No verification code found. Please request a new code."}}async function n(e,r,a){let i=`
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 10px; padding: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #2563eb; margin: 0; }
        .code-box { background: #f0f9ff; border: 2px dashed #2563eb; border-radius: 10px; padding: 30px; text-align: center; margin: 30px 0; }
        .code { font-size: 36px; font-weight: bold; color: #2563eb; letter-spacing: 8px; font-family: monospace; }
        .message { color: #666; line-height: 1.6; }
        .footer { text-align: center; color: #999; font-size: 12px; margin-top: 30px; }
        .warning { background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px; color: #92400e; font-size: 14px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="logo">
          <h1>üõí CTG Collection</h1>
        </div>
        
        <p class="message">
          ${"email_verify"===a?"Thank you for registering! Please use the code below to verify your email address:":"You requested a login verification code. Enter this code to complete your sign in:"}
        </p>
        
        <div class="code-box">
          <div class="code">${r}</div>
        </div>
        
        <p class="message">
          This code will expire in <strong>10 minutes</strong>.
        </p>
        
        <div class="warning">
          ‚ö†Ô∏è If you didn't request this code, please ignore this email. Someone may have entered your email by mistake.
        </div>
        
        <div class="footer">
          <p>CTG Collection - Premium E-Commerce Store</p>
          <p>This is an automated message, please do not reply.</p>
        </div>
      </div>
    </body>
    </html>
  `;try{return await (0,t.sendEmailWithAttachments)({to:e,subject:"email_verify"===a?"Verify Your Email - CTG Collection":"Login Verification Code - CTG Collection",html:i}),!0}catch(e){return console.error("Failed to send verification email:",e),!1}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),i=r.X(0,[8948,5972,8691,8840,5245,1067,6119],()=>a(81959));module.exports=i})();