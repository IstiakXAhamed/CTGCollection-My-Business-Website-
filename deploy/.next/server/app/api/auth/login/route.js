"use strict";(()=>{var e={};e.id=8873,e.ids=[8873,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},41493:(e,i,t)=>{t.r(i),t.d(i,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>x,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var r={};t.r(r),t.d(r,{POST:()=>p,dynamic:()=>m});var s=t(49303),a=t(88716),o=t(60670),n=t(87070),d=t(72331),l=t(90455),u=t(30971),c=t(30307);let m="force-dynamic";async function p(e){try{let i=await e.json();if(i.verify2FA&&i.email&&i.code)return g(i.email.toLowerCase().trim(),i.code);let t=u.dm.parse(i),r=!0===i.rememberMe,s=t.email.toLowerCase().trim(),a=await d.prisma.user.findUnique({where:{email:s}});if(!a)return n.NextResponse.json({message:"Invalid email or password"},{status:401});if(!a.password)return n.NextResponse.json({message:"This account uses social login. Please sign in with Google."},{status:401});if(!await (0,l.Gv)(t.password,a.password))return n.NextResponse.json({message:"Invalid email or password"},{status:401});if(!1===a.isActive)return n.NextResponse.json({message:"Your account has been deactivated. Please contact support."},{status:403});if(!a.emailVerified&&"customer"===a.role)return n.NextResponse.json({message:"Please verify your email before logging in",requiresVerification:!0,email:a.email},{status:403});let o=!0===i.isAdminLogin;if(("admin"===a.role||"superadmin"===a.role)&&!o)try{let e=await d.prisma.siteSettings.findUnique({where:{id:"main"},select:{unifiedLogin:!0}});if(e&&!1===e.unifiedLogin)return n.NextResponse.json({message:"Administrators must use the admin login page at /admin/login"},{status:403})}catch(e){}if(a.twoFactorEnabled){let e=await (0,c.D_)(a.email,"login_2fa",a.id);return await (0,c.zk)(a.email,e,"login_2fa"),n.NextResponse.json({message:"Two-factor authentication required",requires2FA:!0,email:a.email})}let m=await (0,l.V3)({userId:a.id,email:a.email,role:a.role}),p=n.NextResponse.json({message:"Login successful",user:{id:a.id,name:a.name,email:a.email,role:a.role},token:m});return p.cookies.set("token",m,{httpOnly:!0,secure:!0,sameSite:"lax",...r?{maxAge:604800}:{},path:"/"}),p}catch(e){if(console.error("Login error:",e),"ZodError"===e.name)return n.NextResponse.json({message:"Invalid input data",errors:e.errors},{status:400});return n.NextResponse.json({message:"Login failed"},{status:500})}}async function g(e,i){try{let t=await (0,c.VP)(e,i,"login_2fa");if(!t.success)return n.NextResponse.json({message:t.message},{status:400});let r=await d.prisma.user.findUnique({where:{email:e}});if(!r)return n.NextResponse.json({message:"User not found"},{status:404});let s=await (0,l.V3)({userId:r.id,email:r.email,role:r.role}),a=n.NextResponse.json({message:"Login successful",user:{id:r.id,name:r.name,email:r.email,role:r.role},token:s});return a.cookies.set("token",s,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"}),a}catch(e){return console.error("2FA verification error:",e),n.NextResponse.json({message:"Verification failed"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:h,serverHooks:y}=f,v="/api/auth/login/route";function w(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},90455:(e,i,t)=>{t.d(i,{Gv:()=>d,RA:()=>c,V3:()=>l,c_:()=>n,verifyToken:()=>u});var r=t(98691),s=t(6091),a=t(6176);t(71615);let o=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function n(e){return r.ZP.hash(e,10)}async function d(e,i){return r.ZP.compare(e,i)}async function l(e){return new s.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(o)}async function u(e){try{return(await (0,a._)(e,o)).payload}catch(e){return null}}async function c(e){try{let i=e.cookies.get("token")?.value;if(!i)return null;let r=await u(i);if(!r)return null;let{prisma:s}=await t.e(7356).then(t.bind(t,72331)),a=await s.user.findUnique({where:{id:r.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!a||!1===a.isActive)return null;return{id:a.id,userId:a.id,email:a.email,name:a.name,role:a.role,permissions:a.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},72331:(e,i,t)=>{t.d(i,{prisma:()=>a});var r=t(53524);let s=globalThis,a=s.prisma??new r.PrismaClient({log:["error"]});s.prisma=a},30971:(e,i,t)=>{t.d(i,{dm:()=>a,gY:()=>s});var r=t(21067);let s=r.Ry({name:r.Z_().min(2,"Name must be at least 2 characters"),email:r.Z_().email("Invalid email address"),password:r.Z_().min(6,"Password must be at least 6 characters"),phone:r.Z_().optional()}),a=r.Ry({email:r.Z_().email("Invalid email address"),password:r.Z_().min(1,"Password is required")});r.Ry({name:r.Z_().min(2,"Name is required"),phone:r.Z_().min(11,"Valid phone number is required"),address:r.Z_().min(10,"Address is required"),city:r.Z_().min(2,"City is required"),district:r.Z_().min(2,"District is required"),postalCode:r.Z_().optional(),isDefault:r.O7().optional()}),r.Ry({name:r.Z_().min(3,"Product name is required"),description:r.Z_().min(10,"Description must be at least 10 characters"),categoryId:r.Z_().min(1,"Category is required"),basePrice:r.Rx().positive("Price must be positive"),salePrice:r.Rx().optional(),images:r.IX(r.Z_()).min(1,"At least one image is required"),isFeatured:r.O7().optional(),isBestseller:r.O7().optional()}),r.Ry({name:r.Z_().min(2,"Category name is required"),description:r.Z_().optional(),image:r.Z_().optional(),parentId:r.Z_().optional()}),r.Ry({code:r.Z_().min(3,"Coupon code is required").toUpperCase(),description:r.Z_().optional(),discountType:r.Km(["percentage","fixed"]),discountValue:r.Rx().positive("Discount value must be positive"),minOrderValue:r.Rx().optional(),maxDiscount:r.Rx().optional(),validFrom:r.hT(),validUntil:r.hT(),usageLimit:r.Rx().optional()}),r.Ry({productId:r.Z_().min(1,"Product ID is required"),rating:r.Rx().min(1).max(5,"Rating must be between 1 and 5"),comment:r.Z_().min(10,"Review must be at least 10 characters").optional()})},30307:(e,i,t)=>{t.d(i,{D_:()=>a,VP:()=>o,zk:()=>n});var r=t(72331),s=t(36119);async function a(e,i,t){await r.prisma.verificationCode.deleteMany({where:{email:e,type:i}});let s=Math.floor(1e5+9e5*Math.random()).toString(),a=new Date(Date.now()+3e5);return await r.prisma.verificationCode.create({data:{code:s,type:i,email:e,userId:t,expiresAt:a}}),s}async function o(e,i,t){let s=await r.prisma.verificationCode.findFirst({where:{email:e,type:t,used:!1},orderBy:{createdAt:"desc"}});return s?new Date>s.expiresAt?(await r.prisma.verificationCode.delete({where:{id:s.id}}),{success:!1,message:"Verification code expired. Please request a new code."}):s.attempts>=5?(await r.prisma.verificationCode.delete({where:{id:s.id}}),{success:!1,message:"Too many failed attempts. Please request a new code."}):s.code!==i?(await r.prisma.verificationCode.update({where:{id:s.id},data:{attempts:{increment:1}}}),{success:!1,message:`Invalid code. ${4-s.attempts} attempts remaining.`}):(await r.prisma.verificationCode.update({where:{id:s.id},data:{used:!0}}),{success:!0,message:"Code verified successfully",userId:s.userId||void 0}):{success:!1,message:"No verification code found. Please request a new code."}}async function n(e,i,t){let r=`
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 10px; padding: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #2563eb; margin: 0; }
        .code-box { background: #f0f9ff; border: 2px dashed #2563eb; border-radius: 10px; padding: 30px; text-align: center; margin: 30px 0; }
        .code { font-size: 36px; font-weight: bold; color: #2563eb; letter-spacing: 8px; font-family: monospace; }
        .message { color: #666; line-height: 1.6; }
        .footer { text-align: center; color: #999; font-size: 12px; margin-top: 30px; }
        .warning { background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px; color: #92400e; font-size: 14px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="logo">
          <h1>üõí CTG Collection</h1>
        </div>
        
        <p class="message">
          ${"email_verify"===t?"Thank you for registering! Please use the code below to verify your email address:":"You requested a login verification code. Enter this code to complete your sign in:"}
        </p>
        
        <div class="code-box">
          <div class="code">${i}</div>
        </div>
        
        <p class="message">
          This code will expire in <strong>10 minutes</strong>.
        </p>
        
        <div class="warning">
          ‚ö†Ô∏è If you didn't request this code, please ignore this email. Someone may have entered your email by mistake.
        </div>
        
        <div class="footer">
          <p>CTG Collection - Premium E-Commerce Store</p>
          <p>This is an automated message, please do not reply.</p>
        </div>
      </div>
    </body>
    </html>
  `;try{return await (0,s.sendEmailWithAttachments)({to:e,subject:"email_verify"===t?"Verify Your Email - CTG Collection":"Login Verification Code - CTG Collection",html:r}),!0}catch(e){return console.error("Failed to send verification email:",e),!1}}}};var i=require("../../../../webpack-runtime.js");i.C(e);var t=e=>i(i.s=e),r=i.X(0,[8948,5972,8691,8840,5245,1067,6119],()=>t(41493));module.exports=r})();