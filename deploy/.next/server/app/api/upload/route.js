"use strict";(()=>{var e={};e.id=5998,e.ids=[5998,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},52040:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>R,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>_,serverHooks:()=>g,staticGenerationAsyncStorage:()=>A});var s={};t.r(s),t.d(s,{GET:()=>x,POST:()=>m,dynamic:()=>f});var o=t(49303),n=t(88716),i=t(60670),a=t(87070);let u=require("fs/promises");var l=t(92048),p=t(55315),c=t.n(p),d=t(90455);let f="force-dynamic";async function m(e){try{let r=await (0,d.RA)(e);if(!r)return a.NextResponse.json({error:"Authentication required for uploads"},{status:401});let s=await e.formData(),o=s.get("file"),n=s.get("folder")||"uploads";if(!o)return a.NextResponse.json({error:"No file provided"},{status:400});if(o.size>10485760)return a.NextResponse.json({error:"File too large"},{status:400});let i=n.replace(/[^a-zA-Z0-9-_/]/g,""),p="superadmin"===r.role?i:`users/${r.id}/${i}`;if(process.env.CLOUDINARY_CLOUD_NAME&&process.env.CLOUDINARY_API_KEY&&process.env.CLOUDINARY_API_SECRET){let{v2:e}=await t.e(9319).then(t.t.bind(t,49788,23));e.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});let r=await o.arrayBuffer(),s=Buffer.from(r);return new Promise(r=>{e.uploader.upload_stream({folder:`ctg-collection/${p}`,resource_type:"auto"},(e,t)=>{e?(console.error("Cloudinary Error:",e),r(a.NextResponse.json({error:"Upload failed"},{status:500}))):r(a.NextResponse.json({success:!0,url:t?.secure_url,publicId:t?.public_id,fileName:o.name,size:o.size,type:o.type}))}).end(s)})}{let e=Date.now(),r=o.name.replace(/[^a-zA-Z0-9.-]/g,"_"),t=`${e}_${r}`,s=c().join(process.cwd(),"public","uploads",p);(0,l.existsSync)(s)||await (0,u.mkdir)(s,{recursive:!0});let n=await o.arrayBuffer(),i=Buffer.from(n),d=c().join(s,t);return await (0,u.writeFile)(d,i),a.NextResponse.json({success:!0,url:`/uploads/${p}/${t}`,fileName:t,type:o.type,warning:"Using local storage (Ephemeral). Configure Cloudinary for production."})}}catch(e){return console.error("Upload error:",e),a.NextResponse.json({error:e.message},{status:500})}}async function x(e){try{let r=await (0,d.RA)(e);if(!r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url),o=s.get("folder")||"",n="";if("superadmin"===r.role||r.permissions?.includes("manage_storage"))n=o;else{let e=o.replace(/[^a-zA-Z0-9-_/]/g,"");n=`users/${r.id}/${e}`}if(n=n.replace(/^\/+|\.+/g,""),process.env.CLOUDINARY_CLOUD_NAME&&process.env.CLOUDINARY_API_KEY&&process.env.CLOUDINARY_API_SECRET){let{v2:e}=await t.e(9319).then(t.t.bind(t,49788,23));e.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});let r=await e.search.expression(`folder:ctg-collection/${n}/*`).sort_by("created_at","desc").max_results(50).execute();return a.NextResponse.json({files:r.resources.map(e=>({name:e.filename,url:e.secure_url,size:e.bytes,createdAt:e.created_at}))})}{let e=c().join(process.cwd(),"public","uploads",n);if(!(0,l.existsSync)(e))return a.NextResponse.json({files:[]});let r=t(92048),s=r.readdirSync(e).map(t=>{let s=r.statSync(c().join(e,t));return{name:t,url:`/uploads/${n}/${t}`,size:s.size,createdAt:s.birthtime}});return a.NextResponse.json({files:s})}}catch(e){return console.error("List files error:",e),a.NextResponse.json({error:e.message},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\upload\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:A,serverHooks:g}=_,R="/api/upload/route";function v(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:A})}},90455:(e,r,t)=>{t.d(r,{Gv:()=>u,RA:()=>c,V3:()=>l,c_:()=>a,verifyToken:()=>p});var s=t(98691),o=t(6091),n=t(6176);t(71615);let i=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function a(e){return s.ZP.hash(e,10)}async function u(e,r){return s.ZP.compare(e,r)}async function l(e){return new o.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(i)}async function p(e){try{return(await (0,n._)(e,i)).payload}catch(e){return null}}async function c(e){try{let r=e.cookies.get("token")?.value;if(!r)return null;let s=await p(r);if(!s)return null;let{prisma:o}=await t.e(7356).then(t.bind(t,72331)),n=await o.user.findUnique({where:{id:s.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!n||!1===n.isActive)return null;return{id:n.id,userId:n.id,email:n.email,name:n.name,role:n.role,permissions:n.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,5972,8691,8840],()=>t(52040));module.exports=s})();