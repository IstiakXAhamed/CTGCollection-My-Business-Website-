"use strict";(()=>{var e={};e.id=9426,e.ids=[9426,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},41748:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>x,requestAsyncStorage:()=>y,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{POST:()=>m,dynamic:()=>p});var i=t(49303),n=t(88716),o=t(60670),s=t(87070),d=t(72331),u=t(90455),c=t(76876);async function l(e,r,t,a,i,n,o,s){try{return await d.prisma.inventoryLog.create({data:{productId:e,variantId:o,previousStock:r,newStock:t,change:t-r,reason:a,orderId:n,userId:i,notes:s}}),!0}catch(e){return console.error("Failed to log inventory change:",e),!1}}let p="force-dynamic";async function m(e){try{let r;let{shippingDetails:a,paymentMethod:i,cartItems:n,total:o,subtotal:p,shippingCost:m,couponCode:h}=await e.json();if(!a||!i||!n||!o)return s.NextResponse.json({message:"Missing required fields"},{status:400});if(!n.length)return s.NextResponse.json({message:"Cart is empty"},{status:400});let y=null,f=e.cookies.get("token")?.value;if(f){let e=await (0,u.verifyToken)(f);e?.userId&&await d.prisma.user.findUnique({where:{id:e.userId},select:{id:!0}})&&(y=e.userId)}let w=a.email||null;if(!y&&!w)return s.NextResponse.json({message:"Please provide an email address for order tracking"},{status:400});let g=`CTG${Date.now()}${Math.floor(1e3*Math.random())}`;if(y)r=await d.prisma.address.create({data:{userId:y,name:a.name,phone:a.phone,address:a.address,city:a.city,district:a.district,postalCode:a.postalCode||""}});else{let e=`addr_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;await d.prisma.$executeRaw`
        INSERT INTO "Address" ("id", "userId", "guestEmail", "name", "phone", "address", "city", "district", "postalCode", "isDefault", "createdAt", "updatedAt")
        VALUES (${e}, NULL, ${w||null}, ${a.name}, ${a.phone}, ${a.address}, ${a.city}, ${a.district}, ${a.postalCode||""}, false, NOW(), NOW())
      `,r=await d.prisma.address.findUnique({where:{id:e}})}let x=0;if(h){let e=await d.prisma.coupon.findUnique({where:{code:h}});e&&e.isActive&&new Date>=e.validFrom&&new Date<=e.validUntil&&("percentage"===e.discountType?(x=p*e.discountValue/100,e.maxDiscount&&(x=Math.min(x,e.maxDiscount))):x=e.discountValue,await d.prisma.coupon.update({where:{id:e.id},data:{usedCount:{increment:1}}}))}let v={orderNumber:g,addressId:r.id,subtotal:p||o-(m||0),shippingCost:m||0,discount:x,total:o-x,couponCode:h,paymentMethod:i,paymentStatus:"pending",status:"pending",items:{create:n.map(e=>({productId:e.productId,quantity:e.quantity,price:e.price,variantInfo:JSON.stringify({size:e.size,color:e.color,variantId:e.variantId})}))}};y?v.userId=y:v.guestEmail=w;let b=await d.prisma.order.create({data:v,include:{items:{include:{product:{select:{name:!0,images:!0}}}},address:!0}});for(let e of n)if(e.variantId)try{let r=await d.prisma.productVariant.findUnique({where:{id:e.variantId}});if(r){let t=r.stock;await d.prisma.productVariant.update({where:{id:e.variantId},data:{stock:{decrement:e.quantity}}}),await l(e.productId,t,t-e.quantity,"order",y||"guest",b.id,e.variantId,`Order #${g} - ${e.quantity} units sold`)}}catch(r){console.log("Stock update skipped for variant:",e.variantId,r)}await d.prisma.payment.create({data:{orderId:b.id,method:i,amount:b.total,status:"pending"}});try{await (0,c.r_)(b.id,a.name,b.total),y&&await (0,c.an)(y,b.id),Promise.all([t.e(5245),t.e(6119)]).then(t.bind(t,36119)).then(async({sendOrderConfirmation:e,sendNewOrderSellerEmail:r})=>{let t=n.map(e=>({name:e.name||"Product",quantity:e.quantity,price:e.price}));e({to:a.email||w||"",orderNumber:b.orderNumber,customerName:a.name||"Customer",items:t,subtotal:b.subtotal,shipping:b.shippingCost,discount:b.discount,total:b.total,address:`${a.address}, ${a.city}`,paymentMethod:b.paymentMethod}).catch(console.error);let i={},o=n.map(e=>e.productId);try{(await d.prisma.product.findMany({where:{id:{in:o}},include:{seller:{select:{email:!0}},shop:{include:{owner:{select:{email:!0}}}}}})).forEach(e=>{let r=e.seller?.email||e.shop?.owner?.email;if(r){let t=n.find(r=>r.productId===e.id);t&&(i[r]=(i[r]||0)+t.price*t.quantity)}}),Object.entries(i).forEach(([e,t])=>{r(e,b.orderNumber,t).catch(console.error)})}catch(e){console.error("Seller email error",e)}})}catch(e){console.log("Notification error (non-blocking):",e)}return s.NextResponse.json({success:!0,orderId:b.id,orderNumber:b.orderNumber,order:{id:b.id,orderNumber:b.orderNumber,total:b.total,discount:b.discount,status:b.status}})}catch(e){return console.error("Order creation error:",e),s.NextResponse.json({message:e.message||"Failed to create order"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/orders/create/route",pathname:"/api/orders/create",filename:"route",bundlePath:"app/api/orders/create/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\orders\\create\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:w}=h,g="/api/orders/create/route";function x(){return(0,o.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},90455:(e,r,t)=>{t.d(r,{Gv:()=>d,RA:()=>l,V3:()=>u,c_:()=>s,verifyToken:()=>c});var a=t(98691),i=t(6091),n=t(6176);t(71615);let o=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function s(e){return a.ZP.hash(e,10)}async function d(e,r){return a.ZP.compare(e,r)}async function u(e){return new i.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(o)}async function c(e){try{return(await (0,n._)(e,o)).payload}catch(e){return null}}async function l(e){try{let r=e.cookies.get("token")?.value;if(!r)return null;let a=await c(r);if(!a)return null;let{prisma:i}=await t.e(7356).then(t.bind(t,72331)),n=await i.user.findUnique({where:{id:a.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!n||!1===n.isActive)return null;return{id:n.id,userId:n.id,email:n.email,name:n.name,role:n.role,permissions:n.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},76876:(e,r,t)=>{t.d(r,{A5:()=>h,Eb:()=>f,En:()=>l,KY:()=>w,NF:()=>u,Yp:()=>d,an:()=>s,f_:()=>g,ko:()=>p,oX:()=>y,rB:()=>m,r_:()=>o,wN:()=>c});var a=t(72331);async function i(e,r,t,i,n){try{return await a.prisma.notification.create({data:{userId:e,type:r,title:t,message:i,link:n||null}}),!0}catch(e){return console.error("Failed to create notification:",e),!1}}async function n(e,r,t,i){try{let n=await a.prisma.user.findMany({where:{role:{in:["admin","superadmin"]}},select:{id:!0}});return await Promise.all(n.map(n=>a.prisma.notification.create({data:{userId:n.id,type:e,title:r,message:t,link:i||null}}))),!0}catch(e){return console.error("Failed to notify admins:",e),!1}}async function o(e,r,t){await n("order","\uD83D\uDED2 New Order Received!",`${r} placed an order (৳${t.toLocaleString()})`,"/admin/orders")}async function s(e,r){await i(e,"order","✅ Order Confirmed!","Your order has been confirmed and is being processed.","/dashboard/orders")}async function d(e,r,t){await i(e,"order","\uD83D\uDCE6 Order Shipped!",`Your order is on the way!${t?` Tracking: ${t}`:""}`,"/dashboard/orders")}async function u(e,r){await i(e,"order","\uD83C\uDF89 Order Delivered!","Your order has been delivered. Thank you for shopping with us!","/dashboard/orders")}async function c(e,r,t){await i(e,"order","❌ Order Cancelled",t||"Your order has been cancelled.","/dashboard/orders")}async function l(e,r){await i(e,"welcome","\uD83C\uDF89 Welcome to CTG Collection!",`Hi ${r}, thank you for joining us! Explore our amazing products.`,"/shop")}async function p(e,r){await n("user","\uD83D\uDC64 New User Registered!",`${e} (${r}) just joined.`,"/admin/customers")}async function m(e,r){await n("message","\uD83D\uDCE7 New Contact Message!",`${e}: "${r}"`,"/admin/messages")}async function h(e,r){await n("chat","\uD83D\uDCAC New Chat Message!",`${e} sent a message`,"/admin/chat")}async function y(e,r,t){let a={customer:"Customer",seller:"Seller",admin:"Admin",superadmin:"Super Admin"}[t]||t,n=["admin","seller","superadmin"].includes(t)&&"customer"===r;await i(e,"account",n?"\uD83C\uDF8A Congratulations! Role Upgraded":"\uD83D\uDCCB Account Role Updated",n?`You have been promoted to ${a}! Welcome to the team.`:`Your account role has been changed to ${a}.`,"/dashboard")}async function f(e,r){await i(e,"loyalty","\uD83C\uDFC6 Membership Tier Updated!",`Congratulations! You are now a ${r} member. Enjoy exclusive benefits!`,"/dashboard/loyalty")}async function w(e){await i(e,"account","⚠️ Account Deactivated","Your account has been temporarily deactivated. Please contact support for assistance.",void 0)}async function g(e){await i(e,"account","✅ Account Reactivated","Great news! Your account has been reactivated. Welcome back!","/dashboard")}},72331:(e,r,t)=>{t.d(r,{prisma:()=>n});var a=t(53524);let i=globalThis,n=i.prisma??new a.PrismaClient({log:["error"]});i.prisma=n}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8948,5972,8691,8840],()=>t(41748));module.exports=a})();