"use strict";(()=>{var e={};e.id=970,e.ids=[970,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},56772:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>z,patchFetch:()=>b,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y});var o={};t.r(o),t.d(o,{GET:()=>g,POST:()=>m,dynamic:()=>f});var n=t(49303),i=t(88716),s=t(60670),a=t(87070),l=t(72331),c=t(90455),d=t(44020),u=t(36119),p=t(17820);let f="force-dynamic";async function g(e,{params:r}){try{let t=e.cookies.get("token")?.value,o=t?await (0,c.verifyToken)(t):null,n=await l.prisma.order.findUnique({where:{id:r.id},include:{address:!0,user:{select:{id:!0,email:!0}},items:{include:{product:!0}}}});if(!n)return a.NextResponse.json({error:"Order not found"},{status:404});let i=o&&("admin"===o.role||"superadmin"===o.role),s=o&&n.userId===o.userId,u=!n.userId;if(!i&&!s&&!u)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:p}=new URL(e.url),f=p.get("format");if("html"===f)try{console.log("Generating HTML receipt for order:",r.id);let e=await (0,d.Qc)(n.id);if(!e)return console.error("Order data not found for receipt generation"),a.NextResponse.json({error:"Order data not found"},{status:404});let t=await (0,d.F1)(e);if(console.log("HTML receipt generated, length:",t?.length||0),!t)return a.NextResponse.json({error:"Failed to generate receipt HTML"},{status:500});return a.NextResponse.json({html:t})}catch(e){return console.error("Error generating HTML receipt:",e),a.NextResponse.json({error:e.message||"Failed to generate receipt"},{status:500})}let g=await (0,d.jQ)(n.id);if(!g)return a.NextResponse.json({error:"Failed to generate receipt"},{status:500});return a.NextResponse.json({receiptUrl:g,order:{id:n.id,orderNumber:n.orderNumber,status:n.status,paymentStatus:n.paymentStatus,total:n.total}})}catch(e){return console.error("Error getting receipt:",e),a.NextResponse.json({error:e.message||"Failed to get receipt"},{status:500})}}async function m(e,{params:r}){try{let t=e.cookies.get("token")?.value;if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});let o=await (0,c.verifyToken)(t);if(!o||"admin"!==o.role&&"superadmin"!==o.role)return a.NextResponse.json({error:"Unauthorized"},{status:401});console.log("=== SEND ORDER CONFIRMATION WITH PDF ==="),console.log("Order ID:",r.id);let n=await l.prisma.order.findUnique({where:{id:r.id},include:{address:!0,user:{select:{name:!0,email:!0}},items:{include:{product:!0}}}});if(!n)return a.NextResponse.json({error:"Order not found"},{status:404});let i=n.user?.email||n.guestEmail;if(console.log("Recipient email:",i),!i)return a.NextResponse.json({error:"No email address for this order"},{status:400});console.log("Generating PDF receipt...");let s=await (0,p.Z)(n.id);console.log("PDF generated:",!!s,"Size:",s?.length||0,"bytes"),console.log("Sending order confirmation with PDF attachment...");let d=await (0,u.sendOrderConfirmationWithPDF)({to:i,orderNumber:n.orderNumber,customerName:n.address.name,items:n.items.map(e=>({name:e.product.name,quantity:e.quantity,price:e.price})),subtotal:n.subtotal,shipping:n.shippingCost,discount:n.discount||0,total:n.total,address:`${n.address.address}, ${n.address.city}, ${n.address.district}`,paymentMethod:n.paymentMethod,pdfBuffer:s||void 0});return console.log("Email sent result:",d),d&&await l.prisma.order.update({where:{id:n.id},data:{receiptSentAt:new Date}}),a.NextResponse.json({success:!0,message:d?"âœ… Order confirmation with PDF receipt sent successfully!":"Email sent (PDF may have failed to attach)",hasPDF:!!s})}catch(e){return console.error("Error sending receipt:",e),a.NextResponse.json({error:e.message||"Failed to send receipt"},{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/orders/[id]/receipt/route",pathname:"/api/orders/[id]/receipt",filename:"route",bundlePath:"app/api/orders/[id]/receipt/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\orders\\[id]\\receipt\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:x,staticGenerationAsyncStorage:y,serverHooks:w}=h,z="/api/orders/[id]/receipt/route";function b(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},90455:(e,r,t)=>{t.d(r,{Gv:()=>l,RA:()=>u,V3:()=>c,c_:()=>a,verifyToken:()=>d});var o=t(98691),n=t(6091),i=t(6176);t(71615);let s=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function a(e){return o.ZP.hash(e,10)}async function l(e,r){return o.ZP.compare(e,r)}async function c(e){return new n.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(s)}async function d(e){try{return(await (0,i._)(e,s)).payload}catch(e){return null}}async function u(e){try{let r=e.cookies.get("token")?.value;if(!r)return null;let o=await d(r);if(!o)return null;let{prisma:n}=await t.e(7356).then(t.bind(t,72331)),i=await n.user.findUnique({where:{id:o.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!i||!1===i.isActive)return null;return{id:i.id,userId:i.id,email:i.email,name:i.name,role:i.role,permissions:i.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},17820:(e,r,t)=>{t.d(r,{Z:()=>l});var o=t(6271),n=t(44020);let i=e=>new Date(e).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"}),s=e=>{if(!e)return"-";try{let r=JSON.parse(e);return`${r.size||""}${r.color?" / "+r.color:""}`.trim()||"-"}catch{return"-"}};function a(e,r,t,o,n){e.drawText(r,{x:t,y:o,size:n.size,font:n.font,color:n.color,maxWidth:n.maxWidth})}async function l(e){try{console.log("Generating PDF for order:",e);let r=await (0,n.Qc)(e);if(!r)return console.error("Order not found for PDF generation:",e),null;let t=await o.PDFDocument.create(),l=t.addPage([595,842]),{width:c,height:d}=l.getSize(),u=await t.embedFont(o.StandardFonts.Helvetica),p=await t.embedFont(o.StandardFonts.HelveticaBold),f=(0,o.rgb)(.11,.19,.33),g=(0,o.rgb)(.13,.13,.13),m=(0,o.rgb)(.47,.47,.47),h=(0,o.rgb)(.96,.96,.96),x=(0,o.rgb)(.16,.65,.53),y=(0,o.rgb)(1,1,1),w=d-50;l.drawRectangle({x:0,y:d-100,width:c,height:100,color:y}),a(l,"CTG",50,w-5,{font:p,size:24,color:f}),a(l,"Collection",105,w-5,{font:u,size:18,color:f}),a(l,"Premium Fashion & Lifestyle",50,w-22,{font:u,size:9,color:m}),a(l,"INVOICE",c-50-130,w,{font:u,size:9,color:m}),a(l,r.orderNumber,c-50-130,w-16,{font:p,size:14,color:f}),a(l,i(r.createdAt),c-50-130,w-32,{font:u,size:10,color:m}),w-=70,l.drawLine({start:{x:50,y:w},end:{x:c-50,y:w},thickness:1.5,color:f}),w-=35,a(l,"BILL TO",50,w,{font:p,size:9,color:m}),w-=16,a(l,r.address.name,50,w,{font:p,size:11,color:g}),w-=14,a(l,r.user?.email||r.guestEmail||"",50,w,{font:u,size:10,color:m}),w-=12,a(l,r.address.phone,50,w,{font:u,size:10,color:m});let z=w+42;for(let e of(a(l,"SHIP TO",c/2,z,{font:p,size:9,color:m}),z-=16,a(l,r.address.name,c/2,z,{font:p,size:11,color:g}),z-=14,a(l,r.address.address,c/2,z,{font:u,size:10,color:m,maxWidth:200}),z-=12,a(l,`${r.address.city}, ${r.address.district}`,c/2,z,{font:u,size:10,color:m}),w-=45,l.drawRectangle({x:50,y:w-8,width:c-100,height:24,color:h}),a(l,"ITEM",60,w,{font:p,size:9,color:m}),a(l,"VARIANT",220,w,{font:p,size:9,color:m}),a(l,"QTY",340,w,{font:p,size:9,color:m}),a(l,"PRICE",410,w,{font:p,size:9,color:m}),a(l,"TOTAL",490,w,{font:p,size:9,color:m}),w-=30,r.items)){a(l,e.product.name,60,w,{font:p,size:10,color:g});let r=s(e.variantInfo);a(l,r,220,w,{font:u,size:10,color:m}),a(l,e.quantity.toString(),340,w,{font:u,size:10,color:g}),a(l,`Tk${e.price.toLocaleString()}`,410,w,{font:u,size:10,color:g});let t=e.price*e.quantity;a(l,`Tk${t.toLocaleString()}`,490,w,{font:p,size:10,color:g}),w-=28,l.drawLine({start:{x:50,y:w+12},end:{x:c-50,y:w+12},thickness:.5,color:(0,o.rgb)(.9,.9,.9)})}w-=15,l.drawRectangle({x:50,y:w-80,width:c-100,height:90,color:h});let b=c-50-80;a(l,"Subtotal",70,w,{font:u,size:10,color:m}),a(l,`Tk${r.subtotal.toLocaleString()}`,b,w,{font:u,size:10,color:g}),w-=18,a(l,"Shipping",70,w,{font:u,size:10,color:m}),a(l,`Tk${r.shippingCost.toLocaleString()}`,b,w,{font:u,size:10,color:g}),w-=18,r.discount>0&&(a(l,"Discount",70,w,{font:u,size:10,color:x}),a(l,`-Tk${r.discount.toLocaleString()}`,b,w,{font:u,size:10,color:x}),w-=18),l.drawLine({start:{x:60,y:w+5},end:{x:c-50-10,y:w+5},thickness:1,color:(0,o.rgb)(.85,.85,.85)}),w-=8,a(l,"Total",70,w,{font:p,size:12,color:f}),a(l,`Tk${r.total.toLocaleString()}`,b-10,w,{font:p,size:14,color:f}),w-=40,l.drawRectangle({x:50,y:w-25,width:c-100,height:40,color:y,borderColor:(0,o.rgb)(.9,.9,.9),borderWidth:1});let q="cod"===r.paymentMethod?"Cash on Delivery":"Online Payment";if(a(l,`Payment: ${q}`,65,w-5,{font:p,size:10,color:g}),"paid"===r.paymentStatus){let e=c-50-70,r=w-12;l.drawRectangle({x:e,y:r,width:50,height:22,color:x,borderColor:x,borderWidth:1}),a(l,"Paid",e+12,r+6,{font:p,size:10,color:y})}w-=50,r.verificationCode&&(l.drawRectangle({x:50,y:w-25,width:c-100,height:40,color:h,borderColor:(0,o.rgb)(.9,.9,.9),borderWidth:1}),a(l,"Verification Code",65,w-5,{font:u,size:9,color:m}),a(l,r.verificationCode,c-50-80,w-5,{font:p,size:14,color:f})),l.drawRectangle({x:0,y:0,width:c,height:60,color:f}),a(l,"Thank you for shopping with CTG Collection! * ctgcollection2@gmail.com",100,32,{font:u,size:10,color:y});let R=await t.save();return console.log("PDF generated successfully, size:",R.length,"bytes"),Buffer.from(R)}catch(e){return console.error("Error generating PDF:",e),null}}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[8948,5972,8691,8840,5245,6271,6119,4020],()=>t(56772));module.exports=o})();