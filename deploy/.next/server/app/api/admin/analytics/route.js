"use strict";(()=>{var e={};e.id=7777,e.ids=[7777,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},17485:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>l,dynamic:()=>c});var n=r(49303),o=r(88716),i=r(60670),s=r(87070),u=r(72331),d=r(90455);let c="force-dynamic";async function l(e){try{let t=await (0,d.RA)(e);if(!t||"admin"!==t.role&&"superadmin"!==t.role&&"seller"!==t.role)return s.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=r.get("period")||"30d",n="7d"===a?7:"90d"===a?90:30,o=new Date;o.setDate(o.getDate()-n);let i=new Date;i.setDate(i.getDate()-2*n);let c=new Date;c.setDate(c.getDate()-n);let l=await u.prisma.order.findMany({where:{createdAt:{gte:o},paymentStatus:"paid"},include:{items:!0}}),p=await u.prisma.order.findMany({where:{createdAt:{gte:i,lt:c},paymentStatus:"paid"}}),m=l.reduce((e,t)=>e+t.total,0),g=p.reduce((e,t)=>e+t.total,0),y=g>0?(m-g)/g*100:100,h=await u.prisma.user.count({where:{role:"customer"}}),w=await u.prisma.user.count({where:{role:"customer",createdAt:{gte:o}}}),f=await u.prisma.product.count(),x=await u.prisma.productVariant.count({where:{stock:{lte:5,gt:0}}}),v=await u.prisma.productVariant.count({where:{stock:0}}),A=l.flatMap(e=>e.items||[]),q={};for(let e of A){if(!q[e.productId]){let t=await u.prisma.product.findUnique({where:{id:e.productId},select:{name:!0}});q[e.productId]={name:t?.name||"Unknown",sold:0,revenue:0}}q[e.productId].sold+=e.quantity,q[e.productId].revenue+=e.price*e.quantity}let k=Object.values(q).sort((e,t)=>t.revenue-e.revenue).slice(0,5),D=await u.prisma.order.findMany({take:5,orderBy:{createdAt:"desc"},select:{id:!0,orderNumber:!0,total:!0,status:!0,createdAt:!0}}),M=e=>{let t=Math.floor((new Date().getTime()-new Date(e).getTime())/1e3);return t<3600?`${Math.floor(t/60)} minutes ago`:t<86400?`${Math.floor(t/3600)} hours ago`:`${Math.floor(t/86400)} days ago`},b=await u.prisma.order.count({where:{status:"pending",createdAt:{gte:o}}});return s.NextResponse.json({revenue:{total:m,change:parseFloat(y.toFixed(1)),period:`vs previous ${n} days`},orders:{total:l.length,change:p.length>0?(l.length-p.length)/p.length*100:100,pending:b,completed:l.length-b},customers:{total:h,new:w,returning:h-w},products:{total:f,lowStock:x,outOfStock:v},topProducts:k,recentOrders:D.map(e=>({id:e.id,orderNumber:e.orderNumber,total:e.total,status:e.status,date:M(e.createdAt)}))})}catch(e){return console.error("Analytics error:",e),s.NextResponse.json({error:e.message},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/analytics/route",pathname:"/api/admin/analytics",filename:"route",bundlePath:"app/api/admin/analytics/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\admin\\analytics\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:y}=p,h="/api/admin/analytics/route";function w(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},90455:(e,t,r)=>{r.d(t,{Gv:()=>u,RA:()=>l,V3:()=>d,c_:()=>s,verifyToken:()=>c});var a=r(98691),n=r(6091),o=r(6176);r(71615);let i=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function s(e){return a.ZP.hash(e,10)}async function u(e,t){return a.ZP.compare(e,t)}async function d(e){return new n.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(i)}async function c(e){try{return(await (0,o._)(e,i)).payload}catch(e){return null}}async function l(e){try{let t=e.cookies.get("token")?.value;if(!t)return null;let a=await c(t);if(!a)return null;let{prisma:n}=await r.e(7356).then(r.bind(r,72331)),o=await n.user.findUnique({where:{id:a.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!o||!1===o.isActive)return null;return{id:o.id,userId:o.id,email:o.email,name:o.name,role:o.role,permissions:o.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},72331:(e,t,r)=>{r.d(t,{prisma:()=>o});var a=r(53524);let n=globalThis,o=n.prisma??new a.PrismaClient({log:["error"]});n.prisma=o}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,8691,8840],()=>r(17485));module.exports=a})();