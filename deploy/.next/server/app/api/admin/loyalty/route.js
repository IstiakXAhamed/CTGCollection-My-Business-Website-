"use strict";(()=>{var e={};e.id=7332,e.ids=[7332,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},67967:(e,r,i)=>{i.r(r),i.d(r,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>S,staticGenerationAsyncStorage:()=>h});var a={};i.r(a),i.d(a,{GET:()=>u,POST:()=>y,PUT:()=>m,dynamic:()=>d});var t=i(49303),n=i(88716),s=i(60670),o=i(87070),l=i(72331),p=i(90455);let d="force-dynamic";async function c(e){let r=await (0,p.RA)(e);return r&&("admin"===r.role||"superadmin"===r.role)?r:null}async function u(e){try{if(!await c(e))return o.NextResponse.json({error:"Admin access required"},{status:401});let r=await l.prisma.loyaltySettings.findFirst();r||(r=await l.prisma.loyaltySettings.create({data:{isEnabled:!0,pointsPerTaka:.1,pointsToTakaRatio:10,referralBonusReferrer:100,referralBonusReferred:50,minimumRedeemPoints:100}}));let i=await l.prisma.loyaltyTier.findMany({orderBy:{minSpending:"asc"},include:{_count:{select:{members:!0}}}}),a=await l.prisma.loyaltyPoints.aggregate({_sum:{totalPoints:!0,lifetimePoints:!0,lifetimeSpent:!0},_count:!0}),t=await l.prisma.referral.groupBy({by:["status"],_count:!0});return o.NextResponse.json({settings:r,tiers:i,stats:{totalMembers:a._count,totalPointsActive:a._sum.totalPoints||0,totalPointsEarned:a._sum.lifetimePoints||0,totalSpending:a._sum.lifetimeSpent||0,referrals:t}})}catch(e){return o.NextResponse.json({error:e.message},{status:500})}}async function m(e){try{if(!await c(e))return o.NextResponse.json({error:"Admin access required"},{status:401});let{isEnabled:r,pointsPerTaka:i,pointsToTakaRatio:a,referralBonusReferrer:t,referralBonusReferred:n,minimumRedeemPoints:s}=await e.json(),p=await l.prisma.loyaltySettings.findFirst();return p=p?await l.prisma.loyaltySettings.update({where:{id:p.id},data:{isEnabled:r??p.isEnabled,pointsPerTaka:i??p.pointsPerTaka,pointsToTakaRatio:a??p.pointsToTakaRatio,referralBonusReferrer:t??p.referralBonusReferrer,referralBonusReferred:n??p.referralBonusReferred,minimumRedeemPoints:s??p.minimumRedeemPoints}}):await l.prisma.loyaltySettings.create({data:{isEnabled:r??!0,pointsPerTaka:i??.1,pointsToTakaRatio:a??10,referralBonusReferrer:t??100,referralBonusReferred:n??50,minimumRedeemPoints:s??100}}),o.NextResponse.json({success:!0,settings:p})}catch(e){return o.NextResponse.json({error:e.message},{status:500})}}async function y(e){try{if(!await c(e))return o.NextResponse.json({error:"Admin access required"},{status:401});let r=await e.json(),{action:i}=r,a=[{name:"bronze",displayName:"Bronze",color:"#CD7F32",icon:"bronze",minSpending:5e3,discountPercent:1,pointsMultiplier:1.5,birthdayBonus:100,freeShipping:!1,freeShippingMin:3e3,prioritySupport:!1,earlyAccess:!0,exclusiveDeals:!1,sortOrder:1},{name:"silver",displayName:"Silver",color:"#C0C0C0",icon:"silver",minSpending:15e3,discountPercent:2,pointsMultiplier:2,birthdayBonus:300,freeShipping:!0,freeShippingMin:1998,prioritySupport:!1,earlyAccess:!0,exclusiveDeals:!1,sortOrder:2},{name:"gold",displayName:"Gold",color:"#FFD700",icon:"gold",minSpending:4e4,discountPercent:4,pointsMultiplier:2.5,birthdayBonus:400,freeShipping:!0,freeShippingMin:1499,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!1,sortOrder:3},{name:"platinum",displayName:"Platinum",color:"#8C8C8C",icon:"platinum",minSpending:6e4,discountPercent:7,pointsMultiplier:3,birthdayBonus:500,freeShipping:!0,freeShippingMin:1199,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!0,sortOrder:4},{name:"diamond",displayName:"Diamond",color:"#B9F2FF",icon:"diamond",minSpending:1e5,discountPercent:9,pointsMultiplier:5,birthdayBonus:1e3,freeShipping:!0,freeShippingMin:1e3,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!0,sortOrder:5},{name:"emerald",displayName:"Emerald",color:"#50C878",icon:"emerald",minSpending:12e4,discountPercent:10,pointsMultiplier:6,birthdayBonus:750,freeShipping:!0,freeShippingMin:1e3,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!0,sortOrder:6},{name:"ruby",displayName:"Ruby",color:"#E0115F",icon:"ruby",minSpending:15e4,discountPercent:11,pointsMultiplier:7,birthdayBonus:1e3,freeShipping:!0,freeShippingMin:800,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!0,sortOrder:7},{name:"sapphire",displayName:"Sapphire",color:"#0F52BA",icon:"sapphire",minSpending:25e4,discountPercent:11,pointsMultiplier:8,birthdayBonus:1500,freeShipping:!0,freeShippingMin:800,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!0,sortOrder:8},{name:"obsidian",displayName:"Obsidian",color:"#1C1C1C",icon:"obsidian",minSpending:4e5,discountPercent:13,pointsMultiplier:10,birthdayBonus:2e3,freeShipping:!0,freeShippingMin:700,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!0,sortOrder:9},{name:"legendary",displayName:"Legendary",color:"#FFD700",icon:"legendary",minSpending:6e5,discountPercent:15,pointsMultiplier:15,birthdayBonus:5e3,freeShipping:!0,freeShippingMin:null,prioritySupport:!0,earlyAccess:!0,exclusiveDeals:!0,sortOrder:10}];if("seed_tiers"===i){if(await l.prisma.loyaltyTier.count()>0)return o.NextResponse.json({error:"Tiers already exist. Use reset_tiers to recreate them."},{status:400});await l.prisma.loyaltyTier.createMany({data:a});let e=await l.prisma.loyaltyTier.findMany({orderBy:{sortOrder:"asc"}});return o.NextResponse.json({success:!0,message:"Premium tiers created",tiers:e})}if("reset_tiers"===i){await l.prisma.loyaltyPoints.updateMany({data:{tierId:null}}),await l.prisma.loyaltyTier.deleteMany({}),await l.prisma.loyaltyTier.createMany({data:a});let e=await l.prisma.loyaltyTier.findMany({orderBy:{sortOrder:"asc"}});return o.NextResponse.json({success:!0,message:"Tiers reset to premium defaults",tiers:e})}if("fix_tier_values"===i){let e=[];for(let[r,i]of Object.entries({bronze:0,silver:5e3,gold:15e3,platinum:35e3,diamond:6e4,emerald:1e5,ruby:15e4,sapphire:25e4,obsidian:4e5,legendary:75e4}))e.push(l.prisma.loyaltyTier.updateMany({where:{name:r},data:{minSpending:i}}));await Promise.all(e);let r=await l.prisma.loyaltyTier.findMany({orderBy:{sortOrder:"asc"}});return o.NextResponse.json({success:!0,message:"Tier minSpending values fixed!",tiers:r})}if("fix_tier_order"===i){let e=await l.prisma.loyaltyTier.findMany();e.sort((e,r)=>e.minSpending-r.minSpending);let r=[];for(let i=0;i<e.length;i++){let a=e[i];r.push(l.prisma.loyaltyTier.update({where:{id:a.id},data:{sortOrder:i+1}}))}r.length>0&&await l.prisma.$transaction(r);let i=await l.prisma.loyaltyTier.findMany({orderBy:[{sortOrder:"asc"},{minSpending:"asc"}]});return o.NextResponse.json({success:!0,message:"Tier order fixed by price!",tiers:i})}if("fix_tier_names"===i){let e=await l.prisma.loyaltyTier.findMany(),r={bronze:{displayName:"Bronze",color:"#CD7F32",icon:"bronze"},silver:{displayName:"Silver",color:"#C0C0C0",icon:"silver"},gold:{displayName:"Gold",color:"#FFD700",icon:"gold"},platinum:{displayName:"Platinum",color:"#8C8C8C",icon:"platinum"},diamond:{displayName:"Diamond",color:"#B9F2FF",icon:"diamond"},emerald:{displayName:"Emerald",color:"#50C878",icon:"emerald"},ruby:{displayName:"Ruby",color:"#E0115F",icon:"ruby"},sapphire:{displayName:"Sapphire",color:"#0F52BA",icon:"sapphire"},obsidian:{displayName:"Obsidian",color:"#1C1C1C",icon:"obsidian"},legendary:{displayName:"Legendary",color:"#FFD700",icon:"legendary"},crown:{displayName:"Legendary",color:"#FFD700",icon:"legendary"}},i=[];for(let a of e){let e=a.name.toLowerCase(),t=r[e];t&&i.push(l.prisma.loyaltyTier.update({where:{id:a.id},data:{displayName:t.displayName,color:t.color,icon:t.icon,name:e}}))}i.length>0&&await l.prisma.$transaction(i);let a=await l.prisma.loyaltyTier.findMany({orderBy:{sortOrder:"asc"}});return o.NextResponse.json({success:!0,message:"Tier names and badges synced (Case Insensitive)!",tiers:a})}if("create_tier"===i){let{tier:e}=r;if(!e||!e.name||!e.displayName)return o.NextResponse.json({error:"Name and displayName are required"},{status:400});if(await l.prisma.loyaltyTier.findUnique({where:{name:e.name}}))return o.NextResponse.json({error:"A tier with this name already exists"},{status:400});let i=((await l.prisma.loyaltyTier.aggregate({_max:{sortOrder:!0}}))._max.sortOrder||0)+1,a=await l.prisma.loyaltyTier.create({data:{name:e.name,displayName:e.displayName,minSpending:e.minSpending||0,discountPercent:e.discountPercent||0,freeShipping:e.freeShipping||!1,freeShippingMin:e.freeShippingMin,pointsMultiplier:e.pointsMultiplier||1,prioritySupport:e.prioritySupport||!1,earlyAccess:e.earlyAccess||!1,exclusiveDeals:e.exclusiveDeals||!1,birthdayBonus:e.birthdayBonus||0,color:e.color||"#CD7F32",icon:e.icon||"medal",isActive:e.isActive??!0,sortOrder:i}});return o.NextResponse.json({success:!0,tier:a})}return o.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return o.NextResponse.json({error:e.message},{status:500})}}let f=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/loyalty/route",pathname:"/api/admin/loyalty",filename:"route",bundlePath:"app/api/admin/loyalty/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\admin\\loyalty\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:S}=f,x="/api/admin/loyalty/route";function w(){return(0,s.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:h})}},90455:(e,r,i)=>{i.d(r,{Gv:()=>l,RA:()=>c,V3:()=>p,c_:()=>o,verifyToken:()=>d});var a=i(98691),t=i(6091),n=i(6176);i(71615);let s=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function o(e){return a.ZP.hash(e,10)}async function l(e,r){return a.ZP.compare(e,r)}async function p(e){return new t.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(s)}async function d(e){try{return(await (0,n._)(e,s)).payload}catch(e){return null}}async function c(e){try{let r=e.cookies.get("token")?.value;if(!r)return null;let a=await d(r);if(!a)return null;let{prisma:t}=await i.e(7356).then(i.bind(i,72331)),n=await t.user.findUnique({where:{id:a.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!n||!1===n.isActive)return null;return{id:n.id,userId:n.id,email:n.email,name:n.name,role:n.role,permissions:n.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},72331:(e,r,i)=>{i.d(r,{prisma:()=>n});var a=i(53524);let t=globalThis,n=t.prisma??new a.PrismaClient({log:["error"]});t.prisma=n}};var r=require("../../../../webpack-runtime.js");r.C(e);var i=e=>r(r.s=e),a=r.X(0,[8948,5972,8691,8840],()=>i(67967));module.exports=a})();