"use strict";(()=>{var e={};e.id=2628,e.ids=[2628,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},22533:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>C,patchFetch:()=>j,requestAsyncStorage:()=>R,routeModule:()=>g,serverHooks:()=>q,staticGenerationAsyncStorage:()=>v});var a={};t.r(a),t.d(a,{DELETE:()=>x,GET:()=>y,POST:()=>w,PUT:()=>h,dynamic:()=>m});var s=t(49303),n=t(88716),o=t(60670),i=t(87070),u=t(72331),c=t(90455),d=t(76876),l=t(36119);let m="force-dynamic";async function p(e){let r=await (0,c.RA)(e);return r&&"superadmin"===r.role?r:null}async function f(e){let r=await (0,c.RA)(e);return r&&("admin"===r.role||"superadmin"===r.role)?r:null}async function y(e){try{let r=await f(e);if(!r)return i.NextResponse.json({error:"Admin access required"},{status:401});let{searchParams:t}=new URL(e.url),a=t.get("role"),s=t.get("search"),n=parseInt(t.get("page")||"1"),o=parseInt(t.get("limit")||"20"),c={};a&&"all"!==a&&(c.role=a),s&&(c.OR=[{name:{contains:s,mode:"insensitive"}},{email:{contains:s,mode:"insensitive"}}]),t.get("includeLoyalty");let[d,l]=await Promise.all([u.prisma.user.findMany({where:c,select:{id:!0,email:!0,name:!0,phone:!0,role:!0,isActive:!0,createdById:!0,createdAt:!0,_count:{select:{orders:!0}},loyaltyPoints:{select:{totalPoints:!0,tierId:!0,tier:{select:{id:!0,name:!0,displayName:!0,color:!0}}}}},orderBy:{createdAt:"desc"},skip:(n-1)*o,take:o}),u.prisma.user.count({where:c})]);return i.NextResponse.json({users:d,isSuperAdmin:"superadmin"===r.role,pagination:{page:n,limit:o,total:l,totalPages:Math.ceil(l/o)}})}catch(e){return i.NextResponse.json({error:e.message},{status:500})}}async function w(e){try{let r=await p(e);if(!r)return i.NextResponse.json({error:"Superadmin access required"},{status:403});let{userId:t,role:a}=await e.json();if(!t||!a)return i.NextResponse.json({error:"User ID and role required"},{status:400});let s=await u.prisma.user.findUnique({where:{id:t}});if(!s)return i.NextResponse.json({error:"User not found"},{status:404});if("superadmin"===s.role)return i.NextResponse.json({error:"Cannot modify superadmin account"},{status:403});if(!["customer","admin","seller"].includes(a))return i.NextResponse.json({error:"Invalid role"},{status:400});let n=await u.prisma.user.update({where:{id:t},data:{role:a,createdById:"admin"===a?r.id:null}});try{await (0,d.oX)(t,s.role,a),await (0,l.sendRoleChangeEmail)(s.email,{customerName:s.name||"Valued Customer",oldRole:s.role,newRole:a})}catch(e){console.error("Failed to send role change notification/email:",e)}let o=null;if(("admin"===a||"seller"===a)&&"admin"!==s.role&&"seller"!==s.role)try{o=await (0,c.V3)({userId:n.id,email:n.email,role:n.role})}catch(e){console.error("Failed to create new token:",e)}return i.NextResponse.json({success:!0,user:{id:n.id,name:n.name,email:n.email,role:n.role},newToken:o,message:o?"Role updated. Please refresh the page to access admin features.":"Role updated successfully"})}catch(e){return i.NextResponse.json({error:e.message},{status:500})}}async function h(e){try{if(!await p(e))return i.NextResponse.json({error:"Superadmin access required"},{status:403});let{userId:r,isActive:t,role:a}=await e.json();if(!r)return i.NextResponse.json({error:"User ID required"},{status:400});let s=await u.prisma.user.findUnique({where:{id:r}});if(!s)return i.NextResponse.json({error:"User not found"},{status:404});if("superadmin"===s.role)return i.NextResponse.json({error:"Cannot modify superadmin account"},{status:403});if("superadmin"===a)return i.NextResponse.json({error:"Cannot create superadmin via API"},{status:403});let n={};void 0!==t&&(n.isActive=t),a&&(n.role=a);let o=await u.prisma.user.update({where:{id:r},data:n});try{a&&a!==s.role&&(await (0,d.oX)(r,s.role,a),await (0,l.sendRoleChangeEmail)(s.email,{customerName:s.name||"Valued Customer",oldRole:s.role,newRole:a})),!1===t&&!1!==s.isActive&&(await (0,d.KY)(r),await (0,l.sendAccountDeactivatedEmail)(s.email,s.name||"Valued Customer")),!0===t&&!1===s.isActive&&(await (0,d.f_)(r),await (0,l.sendAccountReactivatedEmail)(s.email,s.name||"Valued Customer"))}catch(e){console.error("Failed to send status change notification/email:",e)}return i.NextResponse.json({success:!0,user:o})}catch(e){return i.NextResponse.json({error:e.message},{status:500})}}async function x(e){try{let r=await p(e);if(!r)return i.NextResponse.json({error:"Superadmin access required"},{status:403});let{searchParams:t}=new URL(e.url),a=t.get("userId");if(!a)return i.NextResponse.json({error:"User ID required"},{status:400});if(a===r.id)return i.NextResponse.json({error:"Cannot delete your own account"},{status:403});let s=await u.prisma.user.findUnique({where:{id:a}});if(!s)return i.NextResponse.json({error:"User not found"},{status:404});if("superadmin"===s.role)return i.NextResponse.json({error:"Cannot delete superadmin account"},{status:403});try{await (0,l.sendAccountDeletedEmail)(s.email,s.name||"Valued Customer")}catch(e){console.error("Failed to send account deleted email:",e)}return await u.prisma.user.delete({where:{id:a}}),i.NextResponse.json({success:!0})}catch(e){return i.NextResponse.json({error:e.message},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\admin\\users\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:R,staticGenerationAsyncStorage:v,serverHooks:q}=g,C="/api/admin/users/route";function j(){return(0,o.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:v})}},90455:(e,r,t)=>{t.d(r,{Gv:()=>u,RA:()=>l,V3:()=>c,c_:()=>i,verifyToken:()=>d});var a=t(98691),s=t(6091),n=t(6176);t(71615);let o=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function i(e){return a.ZP.hash(e,10)}async function u(e,r){return a.ZP.compare(e,r)}async function c(e){return new s.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(o)}async function d(e){try{return(await (0,n._)(e,o)).payload}catch(e){return null}}async function l(e){try{let r=e.cookies.get("token")?.value;if(!r)return null;let a=await d(r);if(!a)return null;let{prisma:s}=await t.e(7356).then(t.bind(t,72331)),n=await s.user.findUnique({where:{id:a.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!n||!1===n.isActive)return null;return{id:n.id,userId:n.id,email:n.email,name:n.name,role:n.role,permissions:n.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},76876:(e,r,t)=>{t.d(r,{A5:()=>f,Eb:()=>w,En:()=>l,KY:()=>h,NF:()=>c,Yp:()=>u,an:()=>i,f_:()=>x,ko:()=>m,oX:()=>y,rB:()=>p,r_:()=>o,wN:()=>d});var a=t(72331);async function s(e,r,t,s,n){try{return await a.prisma.notification.create({data:{userId:e,type:r,title:t,message:s,link:n||null}}),!0}catch(e){return console.error("Failed to create notification:",e),!1}}async function n(e,r,t,s){try{let n=await a.prisma.user.findMany({where:{role:{in:["admin","superadmin"]}},select:{id:!0}});return await Promise.all(n.map(n=>a.prisma.notification.create({data:{userId:n.id,type:e,title:r,message:t,link:s||null}}))),!0}catch(e){return console.error("Failed to notify admins:",e),!1}}async function o(e,r,t){await n("order","\uD83D\uDED2 New Order Received!",`${r} placed an order (৳${t.toLocaleString()})`,"/admin/orders")}async function i(e,r){await s(e,"order","✅ Order Confirmed!","Your order has been confirmed and is being processed.","/dashboard/orders")}async function u(e,r,t){await s(e,"order","\uD83D\uDCE6 Order Shipped!",`Your order is on the way!${t?` Tracking: ${t}`:""}`,"/dashboard/orders")}async function c(e,r){await s(e,"order","\uD83C\uDF89 Order Delivered!","Your order has been delivered. Thank you for shopping with us!","/dashboard/orders")}async function d(e,r,t){await s(e,"order","❌ Order Cancelled",t||"Your order has been cancelled.","/dashboard/orders")}async function l(e,r){await s(e,"welcome","\uD83C\uDF89 Welcome to CTG Collection!",`Hi ${r}, thank you for joining us! Explore our amazing products.`,"/shop")}async function m(e,r){await n("user","\uD83D\uDC64 New User Registered!",`${e} (${r}) just joined.`,"/admin/customers")}async function p(e,r){await n("message","\uD83D\uDCE7 New Contact Message!",`${e}: "${r}"`,"/admin/messages")}async function f(e,r){await n("chat","\uD83D\uDCAC New Chat Message!",`${e} sent a message`,"/admin/chat")}async function y(e,r,t){let a={customer:"Customer",seller:"Seller",admin:"Admin",superadmin:"Super Admin"}[t]||t,n=["admin","seller","superadmin"].includes(t)&&"customer"===r;await s(e,"account",n?"\uD83C\uDF8A Congratulations! Role Upgraded":"\uD83D\uDCCB Account Role Updated",n?`You have been promoted to ${a}! Welcome to the team.`:`Your account role has been changed to ${a}.`,"/dashboard")}async function w(e,r){await s(e,"loyalty","\uD83C\uDFC6 Membership Tier Updated!",`Congratulations! You are now a ${r} member. Enjoy exclusive benefits!`,"/dashboard/loyalty")}async function h(e){await s(e,"account","⚠️ Account Deactivated","Your account has been temporarily deactivated. Please contact support for assistance.",void 0)}async function x(e){await s(e,"account","✅ Account Reactivated","Great news! Your account has been reactivated. Welcome back!","/dashboard")}},72331:(e,r,t)=>{t.d(r,{prisma:()=>n});var a=t(53524);let s=globalThis,n=s.prisma??new a.PrismaClient({log:["error"]});s.prisma=n}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8948,5972,8691,8840,5245,6119],()=>t(22533));module.exports=a})();