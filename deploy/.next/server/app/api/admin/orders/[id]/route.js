"use strict";(()=>{var e={};e.id=319,e.ids=[319,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},42913:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>q,patchFetch:()=>D,requestAsyncStorage:()=>x,routeModule:()=>g,serverHooks:()=>b,staticGenerationAsyncStorage:()=>v});var a={};t.r(a),t.d(a,{GET:()=>h,PUT:()=>w,dynamic:()=>f});var i=t(49303),n=t(88716),o=t(60670),s=t(87070),d=t(72331),u=t(90455),l=t(44020),c=t(36119),p=t(76876);async function m(e){try{let r=await d.prisma.loyaltyPoints.findUnique({where:{userId:e},include:{tier:!0}});if(!r)return console.log(`No loyalty points found for user ${e}`),null;let t=r.lifetimeSpent||0,a=await d.prisma.loyaltyTier.findMany({where:{isActive:!0},orderBy:{minSpending:"desc"}}),i=null;for(let e of a)if(t>=e.minSpending){i=e;break}if(!i)return console.log(`User ${e} doesn't qualify for any tier (spent: ${t})`),null;if(r.tierId===i.id)return console.log(`User ${e} already has correct tier: ${i.name}`),null;await d.prisma.loyaltyPoints.update({where:{userId:e},data:{tierId:i.id,tierUpdatedAt:new Date},include:{tier:!0}}),console.log(`User ${e} tier updated: ${r.tier?.name||"None"} → ${i.name}`);let n=await d.prisma.user.findUnique({where:{id:e},select:{email:!0,name:!0}});return n?.email&&(await (0,p.Eb)(e,i.displayName||i.name),await (0,c.sendTierUpdateEmail)(n.email,{customerName:n.name,tierName:i.name,benefits:{Bronze:["Earn 1 point per $1","Birthday Bonus"],Silver:["Earn 1.5 points per $1","Birthday Bonus","Free Shipping"],Gold:["Earn 2 points per $1","Priority Support","Free Shipping","Exclusive Deals"],Platinum:["Earn 3 points per $1","Dedicated Manager","Free Shipping","VIP Access"],Diamond:["Earn 5 points per $1","Personal Shopper","Free Shipping","VIP Access","Early Access"]}[i.name]||["Exclusive member perks"]})),{oldTier:r.tier?.name||"None",newTier:i.name,lifetimeSpent:t}}catch(e){return console.error("Error calculating tier for user:",e),null}}let f="force-dynamic";async function y(e){let r=await (0,u.RA)(e);return r&&("admin"===r.role||"superadmin"===r.role||"seller"===r.role)?r:null}async function h(e,{params:r}){try{if(!await y(e))return s.NextResponse.json({error:"Unauthorized"},{status:401});let t=await d.prisma.order.findUnique({where:{id:r.id},include:{user:{select:{name:!0,email:!0,phone:!0}},items:{include:{product:!0}},address:!0,payment:!0}});if(!t)return s.NextResponse.json({error:"Order not found"},{status:404});return s.NextResponse.json({order:t})}catch(e){return console.error("Get order error:",e),s.NextResponse.json({error:e.message},{status:500})}}async function w(e,{params:r}){try{if(!await y(e))return s.NextResponse.json({error:"Unauthorized"},{status:401});let{status:a,paymentStatus:i,trackingNumber:n,notes:o,sendEmail:u}=await e.json(),f=await d.prisma.order.findUnique({where:{id:r.id},include:{user:{select:{name:!0,email:!0}},items:{include:{product:!0}},address:!0}});if(!f)return s.NextResponse.json({error:"Order not found"},{status:404});let h={};a&&(h.status=a),i&&(h.paymentStatus=i),void 0!==n&&(h.trackingNumber=n),void 0!==o&&(h.notes=o),"paid"===i&&"paid"!==f.paymentStatus&&(h.paymentConfirmedAt=new Date);let w=await d.prisma.order.update({where:{id:r.id},data:h,include:{user:{select:{name:!0,email:!0}},items:{include:{product:!0}},address:!0}}),g=!1,x=null;if("paid"===i&&"paid"!==f.paymentStatus){(x=await (0,l.jQ)(w.id))&&await d.prisma.order.update({where:{id:w.id},data:{receiptUrl:x}});let e=w.user?.email||f.guestEmail;if(console.log("=== RECEIPT EMAIL DEBUG ==="),console.log("Recipient email:",e),console.log("Receipt URL:",x),console.log("Send email flag:",u),e&&!1!==u)try{let{generateTemplatedPDF:r}=await Promise.all([t.e(6271),t.e(7523)]).then(t.bind(t,47523)),{sendOrderConfirmationWithPDF:a}=await Promise.resolve().then(t.bind(t,36119));console.log("Generating PDF for email attachment...");let i=await r(w.id);console.log("PDF generated:",!!i,"Size:",i?.length||0,"bytes"),g=await a({to:e,orderNumber:w.orderNumber,customerName:w.address.name,items:w.items.map(e=>({name:e.product.name,quantity:e.quantity,price:e.price})),subtotal:w.subtotal,shipping:w.shippingCost,discount:w.discount||0,total:w.total,address:`${w.address.address}, ${w.address.city}, ${w.address.district}`,paymentMethod:w.paymentMethod,pdfBuffer:i||void 0}),console.log("Email sent result:",g),g&&await d.prisma.order.update({where:{id:w.id},data:{receiptSentAt:new Date}})}catch(e){console.error("Failed to send receipt email:",e)}else console.log("Skipping email - no recipient or sendEmail is false")}if("shipped"===a&&"shipped"!==f.status&&f.userId)try{await (0,p.Yp)(f.userId,w.id,n)}catch(e){console.log("Notification error (non-blocking):",e)}if("delivered"===a&&"delivered"!==f.status&&f.userId)try{await (0,p.NF)(f.userId,w.id);try{let e=await d.prisma.siteSettings.findUnique({where:{id:"main"}});if(e&&e.pointsPerTaka>0){let r=Math.floor(f.total*e.pointsPerTaka);if(r>0){await d.prisma.loyaltyPoints.upsert({where:{userId:f.userId},create:{userId:f.userId,totalPoints:r,lifetimePoints:r,lifetimeSpent:f.total},update:{totalPoints:{increment:r},lifetimePoints:{increment:r},lifetimeSpent:{increment:f.total}}});let e=await d.prisma.loyaltyPoints.findUnique({where:{userId:f.userId}});if(e){await d.prisma.pointsTransaction.create({data:{userId:f.userId,loyaltyId:e.id,points:r,type:"earned",description:`Points earned from order #${w.orderNumber}`,orderId:w.id}});try{await m(f.userId)}catch(e){console.error("Failed to calculate tier:",e)}let t=await d.prisma.user.findUnique({where:{id:f.userId}});t&&await (0,c.sendLoyaltyUpdateEmail)(t.email,{customerName:t.name,type:"Points Earned",points:r,message:"You earned points for your recent order!"})}}}}catch(e){console.error("Loyalty points error:",e)}}catch(e){console.log("Notification error (non-blocking):",e)}if("cancelled"===a&&"cancelled"!==f.status){if(f.userId)try{await (0,p.wN)(f.userId,w.id,o)}catch(e){console.log("Notification error (non-blocking):",e)}for(let e of w.items)if(e.variantInfo)try{let r=JSON.parse(e.variantInfo);r.variantId&&await d.prisma.productVariant.update({where:{id:r.variantId},data:{stock:{increment:e.quantity}}})}catch(e){}}return s.NextResponse.json({order:w,emailSent:g,receiptUrl:x,message:"paid"===i&&"paid"!==f.paymentStatus?"Payment confirmed and receipt generated":"Order updated successfully"})}catch(e){return console.error("Update order error:",e),s.NextResponse.json({error:e.message},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/orders/[id]/route",pathname:"/api/admin/orders/[id]",filename:"route",bundlePath:"app/api/admin/orders/[id]/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\admin\\orders\\[id]\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:v,serverHooks:b}=g,q="/api/admin/orders/[id]/route";function D(){return(0,o.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:v})}},90455:(e,r,t)=>{t.d(r,{Gv:()=>d,RA:()=>c,V3:()=>u,c_:()=>s,verifyToken:()=>l});var a=t(98691),i=t(6091),n=t(6176);t(71615);let o=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function s(e){return a.ZP.hash(e,10)}async function d(e,r){return a.ZP.compare(e,r)}async function u(e){return new i.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(o)}async function l(e){try{return(await (0,n._)(e,o)).payload}catch(e){return null}}async function c(e){try{let r=e.cookies.get("token")?.value;if(!r)return null;let a=await l(r);if(!a)return null;let{prisma:i}=await t.e(7356).then(t.bind(t,72331)),n=await i.user.findUnique({where:{id:a.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!n||!1===n.isActive)return null;return{id:n.id,userId:n.id,email:n.email,name:n.name,role:n.role,permissions:n.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},76876:(e,r,t)=>{t.d(r,{A5:()=>f,Eb:()=>h,En:()=>c,KY:()=>w,NF:()=>u,Yp:()=>d,an:()=>s,f_:()=>g,ko:()=>p,oX:()=>y,rB:()=>m,r_:()=>o,wN:()=>l});var a=t(72331);async function i(e,r,t,i,n){try{return await a.prisma.notification.create({data:{userId:e,type:r,title:t,message:i,link:n||null}}),!0}catch(e){return console.error("Failed to create notification:",e),!1}}async function n(e,r,t,i){try{let n=await a.prisma.user.findMany({where:{role:{in:["admin","superadmin"]}},select:{id:!0}});return await Promise.all(n.map(n=>a.prisma.notification.create({data:{userId:n.id,type:e,title:r,message:t,link:i||null}}))),!0}catch(e){return console.error("Failed to notify admins:",e),!1}}async function o(e,r,t){await n("order","\uD83D\uDED2 New Order Received!",`${r} placed an order (৳${t.toLocaleString()})`,"/admin/orders")}async function s(e,r){await i(e,"order","✅ Order Confirmed!","Your order has been confirmed and is being processed.","/dashboard/orders")}async function d(e,r,t){await i(e,"order","\uD83D\uDCE6 Order Shipped!",`Your order is on the way!${t?` Tracking: ${t}`:""}`,"/dashboard/orders")}async function u(e,r){await i(e,"order","\uD83C\uDF89 Order Delivered!","Your order has been delivered. Thank you for shopping with us!","/dashboard/orders")}async function l(e,r,t){await i(e,"order","❌ Order Cancelled",t||"Your order has been cancelled.","/dashboard/orders")}async function c(e,r){await i(e,"welcome","\uD83C\uDF89 Welcome to CTG Collection!",`Hi ${r}, thank you for joining us! Explore our amazing products.`,"/shop")}async function p(e,r){await n("user","\uD83D\uDC64 New User Registered!",`${e} (${r}) just joined.`,"/admin/customers")}async function m(e,r){await n("message","\uD83D\uDCE7 New Contact Message!",`${e}: "${r}"`,"/admin/messages")}async function f(e,r){await n("chat","\uD83D\uDCAC New Chat Message!",`${e} sent a message`,"/admin/chat")}async function y(e,r,t){let a={customer:"Customer",seller:"Seller",admin:"Admin",superadmin:"Super Admin"}[t]||t,n=["admin","seller","superadmin"].includes(t)&&"customer"===r;await i(e,"account",n?"\uD83C\uDF8A Congratulations! Role Upgraded":"\uD83D\uDCCB Account Role Updated",n?`You have been promoted to ${a}! Welcome to the team.`:`Your account role has been changed to ${a}.`,"/dashboard")}async function h(e,r){await i(e,"loyalty","\uD83C\uDFC6 Membership Tier Updated!",`Congratulations! You are now a ${r} member. Enjoy exclusive benefits!`,"/dashboard/loyalty")}async function w(e){await i(e,"account","⚠️ Account Deactivated","Your account has been temporarily deactivated. Please contact support for assistance.",void 0)}async function g(e){await i(e,"account","✅ Account Reactivated","Great news! Your account has been reactivated. Welcome back!","/dashboard")}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[8948,5972,8691,8840,5245,6119,4020],()=>t(42913));module.exports=a})();