"use strict";(()=>{var e={};e.id=4475,e.ids=[4475,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},51920:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{GET:()=>d,dynamic:()=>c});var o=r(49303),s=r(88716),i=r(60670),a=r(87070),u=r(72331),l=r(90455);let c="force-dynamic";async function p(e,t){if("all"===t)return!0;if(!e)return"all"===t;try{let r=await u.prisma.user.findUnique({where:{id:e},include:{orders:{select:{id:!0}},loyaltyPoints:{include:{tier:!0}}}});if(!r)return!1;let n=r.orders?.length||0;switch(t){case"new_customers":return 0===n;case"returning":return n>0;case"vip":return n>=5;case"loyalty_bronze":return r.loyaltyPoints?.tier?.name?.toLowerCase()==="bronze";case"loyalty_silver":return r.loyaltyPoints?.tier?.name?.toLowerCase()==="silver";case"loyalty_gold":return r.loyaltyPoints?.tier?.name?.toLowerCase()==="gold";case"loyalty_platinum":return r.loyaltyPoints?.tier?.name?.toLowerCase()==="platinum";default:return!0}}catch(e){return console.error("Error checking user audience:",e),!1}}async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("total"),n=t.get("shippingCost")||"0";if(!r)return a.NextResponse.json({error:"Total amount required"},{status:400});let o=parseFloat(r),s=parseFloat(n),i=new Date,c=await (0,l.RA)(e),d=c?.userId||null,m=await u.prisma.coupon.findMany({where:{isActive:!0,autoApply:!0,validFrom:{lte:i},validUntil:{gte:i},OR:[{minOrderValue:null},{minOrderValue:{lte:o}}]},orderBy:{discountValue:"desc"}});if(0===m.length)return a.NextResponse.json({found:!1,message:"No applicable coupons available"});let y=null,g=0,f=0,x=!1;for(let e of m){if(e.usageLimit&&e.usedCount>=e.usageLimit||!await p(d,e.targetAudience||"all"))continue;let t=0,r=!1;"free_shipping"===e.discountType?(t=s,r=!0):"percentage"===e.discountType?(t=o*e.discountValue/100,e.maxDiscount&&t>e.maxDiscount&&(t=e.maxDiscount)):t=e.discountValue,t>g&&(g=t,y=e,f=t,x=r)}if(!y)return a.NextResponse.json({found:!1,message:"No applicable coupons available"});return a.NextResponse.json({found:!0,coupon:{code:y.code,description:y.description,discountType:y.discountType,discountValue:y.discountValue,maxDiscount:y.maxDiscount,minOrderValue:y.minOrderValue,isFreeShipping:x},savings:f,newTotal:x?o:o-f,message:x?`ðŸšš Free shipping applied!`:`ðŸŽ‰ Best coupon auto-applied! You save à§³${f.toFixed(0)}`})}catch(e){return console.error("Error finding best coupon:",e),a.NextResponse.json({error:e.message},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/coupons/best/route",pathname:"/api/coupons/best",filename:"route",bundlePath:"app/api/coupons/best/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\coupons\\best\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:f}=m,x="/api/coupons/best/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},90455:(e,t,r)=>{r.d(t,{Gv:()=>u,RA:()=>p,V3:()=>l,c_:()=>a,verifyToken:()=>c});var n=r(98691),o=r(6091),s=r(6176);r(71615);let i=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function a(e){return n.ZP.hash(e,10)}async function u(e,t){return n.ZP.compare(e,t)}async function l(e){return new o.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(i)}async function c(e){try{return(await (0,s._)(e,i)).payload}catch(e){return null}}async function p(e){try{let t=e.cookies.get("token")?.value;if(!t)return null;let n=await c(t);if(!n)return null;let{prisma:o}=await r.e(7356).then(r.bind(r,72331)),s=await o.user.findUnique({where:{id:n.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!s||!1===s.isActive)return null;return{id:s.id,userId:s.id,email:s.email,name:s.name,role:s.role,permissions:s.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},72331:(e,t,r)=>{r.d(t,{prisma:()=>s});var n=r(53524);let o=globalThis,s=o.prisma??new n.PrismaClient({log:["error"]});o.prisma=s}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,8691,8840],()=>r(51920));module.exports=n})();