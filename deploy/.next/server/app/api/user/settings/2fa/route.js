"use strict";(()=>{var e={};e.id=7024,e.ids=[7024,7356,455],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},47261:e=>{e.exports=require("node:util")},80519:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var r={};s.r(r),s.d(r,{GET:()=>m,POST:()=>p,dynamic:()=>l});var a=s(49303),i=s(88716),o=s(60670),n=s(87070),d=s(72331),c=s(90455),u=s(30307);let l="force-dynamic";async function p(e){try{let t=e.cookies.get("token")?.value;if(!t)return n.NextResponse.json({message:"Not authenticated"},{status:401});let s=await (0,c.verifyToken)(t);if(!s?.userId)return n.NextResponse.json({message:"Invalid token"},{status:401});let{action:r,method:a,code:i}=await e.json(),o=await d.prisma.user.findUnique({where:{id:s.userId},select:{id:!0,email:!0,phone:!0,twoFactorEnabled:!0,twoFactorMethod:!0}});if(!o)return n.NextResponse.json({message:"User not found"},{status:404});switch(r){case"send-code":{let e=await (0,u.D_)(o.email,"login_2fa",o.id);if(!await (0,u.zk)(o.email,e,"login_2fa"))return n.NextResponse.json({message:"Failed to send verification code"},{status:500});return n.NextResponse.json({success:!0,message:"Verification code sent to your email"})}case"enable":{if(!i)return n.NextResponse.json({message:"Verification code is required"},{status:400});let e=await (0,u.VP)(o.email,i,"login_2fa");if(!e.success)return n.NextResponse.json({message:e.message},{status:400});return await d.prisma.user.update({where:{id:o.id},data:{twoFactorEnabled:!0,twoFactorMethod:a||"email"}}),n.NextResponse.json({success:!0,message:"Two-factor authentication enabled successfully"})}case"disable":return await d.prisma.user.update({where:{id:o.id},data:{twoFactorEnabled:!1,twoFactorMethod:null}}),n.NextResponse.json({success:!0,message:"Two-factor authentication disabled"});case"update-method":if("sms"===a&&!o.phone)return n.NextResponse.json({message:"Please add a phone number first"},{status:400});return await d.prisma.user.update({where:{id:o.id},data:{twoFactorMethod:a}}),n.NextResponse.json({success:!0,message:`2FA method updated to ${a}`});default:return n.NextResponse.json({message:"Invalid action"},{status:400})}}catch(e){return console.error("2FA settings error:",e),n.NextResponse.json({message:"Failed to update 2FA settings"},{status:500})}}async function m(e){try{let t=e.cookies.get("token")?.value;if(!t)return n.NextResponse.json({message:"Not authenticated"},{status:401});let s=await (0,c.verifyToken)(t);if(!s?.userId)return n.NextResponse.json({message:"Invalid token"},{status:401});let r=await d.prisma.user.findUnique({where:{id:s.userId},select:{twoFactorEnabled:!0,twoFactorMethod:!0,emailVerified:!0,phone:!0}});return n.NextResponse.json({twoFactorEnabled:r?.twoFactorEnabled||!1,twoFactorMethod:r?.twoFactorMethod||"email",emailVerified:r?.emailVerified||!1,hasPhone:!!r?.phone})}catch(e){return console.error("2FA settings error:",e),n.NextResponse.json({message:"Failed to fetch 2FA settings"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/user/settings/2fa/route",pathname:"/api/user/settings/2fa",filename:"route",bundlePath:"app/api/user/settings/2fa/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\user\\settings\\2fa\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:x,serverHooks:h}=f,w="/api/user/settings/2fa/route";function v(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},90455:(e,t,s)=>{s.d(t,{Gv:()=>d,RA:()=>l,V3:()=>c,c_:()=>n,verifyToken:()=>u});var r=s(98691),a=s(6091),i=s(6176);s(71615);let o=new TextEncoder().encode(process.env.JWT_SECRET||"your-secret-key");async function n(e){return r.ZP.hash(e,10)}async function d(e,t){return r.ZP.compare(e,t)}async function c(e){return new a.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(o)}async function u(e){try{return(await (0,i._)(e,o)).payload}catch(e){return null}}async function l(e){try{let t=e.cookies.get("token")?.value;if(!t)return null;let r=await u(t);if(!r)return null;let{prisma:a}=await s.e(7356).then(s.bind(s,72331)),i=await a.user.findUnique({where:{id:r.userId},select:{id:!0,email:!0,role:!0,name:!0,isActive:!0,permissions:!0}});if(!i||!1===i.isActive)return null;return{id:i.id,userId:i.id,email:i.email,name:i.name,role:i.role,permissions:i.permissions||[]}}catch(e){return console.error("verifyAuth error:",e),null}}},72331:(e,t,s)=>{s.d(t,{prisma:()=>i});var r=s(53524);let a=globalThis,i=a.prisma??new r.PrismaClient({log:["error"]});a.prisma=i},30307:(e,t,s)=>{s.d(t,{D_:()=>i,VP:()=>o,zk:()=>n});var r=s(72331),a=s(36119);async function i(e,t,s){await r.prisma.verificationCode.deleteMany({where:{email:e,type:t}});let a=Math.floor(1e5+9e5*Math.random()).toString(),i=new Date(Date.now()+3e5);return await r.prisma.verificationCode.create({data:{code:a,type:t,email:e,userId:s,expiresAt:i}}),a}async function o(e,t,s){let a=await r.prisma.verificationCode.findFirst({where:{email:e,type:s,used:!1},orderBy:{createdAt:"desc"}});return a?new Date>a.expiresAt?(await r.prisma.verificationCode.delete({where:{id:a.id}}),{success:!1,message:"Verification code expired. Please request a new code."}):a.attempts>=5?(await r.prisma.verificationCode.delete({where:{id:a.id}}),{success:!1,message:"Too many failed attempts. Please request a new code."}):a.code!==t?(await r.prisma.verificationCode.update({where:{id:a.id},data:{attempts:{increment:1}}}),{success:!1,message:`Invalid code. ${4-a.attempts} attempts remaining.`}):(await r.prisma.verificationCode.update({where:{id:a.id},data:{used:!0}}),{success:!0,message:"Code verified successfully",userId:a.userId||void 0}):{success:!1,message:"No verification code found. Please request a new code."}}async function n(e,t,s){let r=`
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 10px; padding: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #2563eb; margin: 0; }
        .code-box { background: #f0f9ff; border: 2px dashed #2563eb; border-radius: 10px; padding: 30px; text-align: center; margin: 30px 0; }
        .code { font-size: 36px; font-weight: bold; color: #2563eb; letter-spacing: 8px; font-family: monospace; }
        .message { color: #666; line-height: 1.6; }
        .footer { text-align: center; color: #999; font-size: 12px; margin-top: 30px; }
        .warning { background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px; color: #92400e; font-size: 14px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="logo">
          <h1>üõí CTG Collection</h1>
        </div>
        
        <p class="message">
          ${"email_verify"===s?"Thank you for registering! Please use the code below to verify your email address:":"You requested a login verification code. Enter this code to complete your sign in:"}
        </p>
        
        <div class="code-box">
          <div class="code">${t}</div>
        </div>
        
        <p class="message">
          This code will expire in <strong>10 minutes</strong>.
        </p>
        
        <div class="warning">
          ‚ö†Ô∏è If you didn't request this code, please ignore this email. Someone may have entered your email by mistake.
        </div>
        
        <div class="footer">
          <p>CTG Collection - Premium E-Commerce Store</p>
          <p>This is an automated message, please do not reply.</p>
        </div>
      </div>
    </body>
    </html>
  `;try{return await (0,a.sendEmailWithAttachments)({to:e,subject:"email_verify"===s?"Verify Your Email - CTG Collection":"Login Verification Code - CTG Collection",html:r}),!0}catch(e){return console.error("Failed to send verification email:",e),!1}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972,8691,8840,5245,6119],()=>s(80519));module.exports=r})();