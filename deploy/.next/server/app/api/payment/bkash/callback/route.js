"use strict";(()=>{var e={};e.id=6411,e.ids=[6411],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72999:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>k,requestAsyncStorage:()=>f,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>y});var o={};r.r(o),r.d(o,{GET:()=>m,dynamic:()=>p});var a=r(49303),s=r(88716),n=r(60670),i=r(87070),c=r(72331),l=r(66854),d=r(36119),u=r(17820);let p="force-dynamic";async function m(e){try{let{searchParams:t}=new URL(e.url),r=t.get("paymentID"),o=t.get("status");if(!r)return i.NextResponse.redirect("https://silkmartbd.com/checkout?error=missing_payment_id");let a=await c.prisma.order.findFirst({where:{paymentId:r},include:{user:!0,address:!0,items:{include:{product:!0}}}});if(!a)return i.NextResponse.redirect("https://silkmartbd.com/checkout?error=order_not_found");if("cancel"===o||"failure"===o)return await c.prisma.order.update({where:{id:a.id},data:{paymentStatus:"failed"}}),i.NextResponse.redirect(`https://silkmartbd.com/checkout?error=payment_${o}`);let s=await (0,l.A3)(r);if(s.success){await c.prisma.order.update({where:{id:a.id},data:{paymentStatus:"paid",status:"confirmed",transactionId:s.transactionId}});let e=a.user?.email||a.guestEmail;if(e){let t=await (0,u.Z)(a.id);await (0,d.sendOrderConfirmationWithPDF)({to:e,orderNumber:a.orderNumber,customerName:a.address.name,items:a.items.map(e=>({name:e.product.name,quantity:e.quantity,price:e.price})),subtotal:a.subtotal,shipping:a.shippingCost,discount:a.discount||0,total:a.total,address:`${a.address.address}, ${a.address.city}, ${a.address.district}`,paymentMethod:"bkash",pdfBuffer:t||void 0})}return i.NextResponse.redirect(`https://silkmartbd.com/order-success?orderId=${a.id}`)}return await c.prisma.order.update({where:{id:a.id},data:{paymentStatus:"failed"}}),i.NextResponse.redirect(`https://silkmartbd.com/checkout?error=payment_failed&message=${encodeURIComponent(s.message||"")}`)}catch(e){return console.error("bKash callback error:",e),i.NextResponse.redirect("https://silkmartbd.com/checkout?error=callback_error")}}let h=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payment/bkash/callback/route",pathname:"/api/payment/bkash/callback",filename:"route",bundlePath:"app/api/payment/bkash/callback/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\payment\\bkash\\callback\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:g}=h,b="/api/payment/bkash/callback/route";function k(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:y})}},66854:(e,t,r)=>{r.d(t,{A3:()=>i,j5:()=>n});let o="true"===process.env.BKASH_IS_SANDBOX?"https://tokenized.sandbox.bka.sh/v1.2.0-beta":"https://tokenized.pay.bka.sh/v1.2.0-beta",a=null;async function s(){if(a&&a.expiry>new Date)return a.token;let e=await fetch(`${o}/tokenized/checkout/token/grant`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",username:process.env.BKASH_USERNAME||"",password:process.env.BKASH_PASSWORD||""},body:JSON.stringify({app_key:process.env.BKASH_APP_KEY,app_secret:process.env.BKASH_APP_SECRET})}),t=await e.json();if("0000"===t.statusCode){let e=new Date;return e.setMinutes(e.getMinutes()+55),a={token:t.id_token,expiry:e},t.id_token}throw Error(t.statusMessage||"Failed to get bKash token")}async function n(e){try{let t=await s(),r=await fetch(`${o}/tokenized/checkout/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",authorization:t,"x-app-key":process.env.BKASH_APP_KEY||""},body:JSON.stringify({mode:"0011",payerReference:e.payerReference,callbackURL:e.callbackURL,amount:e.amount.toString(),currency:"BDT",intent:"sale",merchantInvoiceNumber:e.orderId})}),a=await r.json();if("0000"===a.statusCode)return{success:!0,paymentID:a.paymentID,bkashURL:a.bkashURL,callbackURL:a.callbackURL,successCallbackURL:a.successCallbackURL,failureCallbackURL:a.failureCallbackURL,cancelledCallbackURL:a.cancelledCallbackURL};return{success:!1,message:a.statusMessage||"Payment creation failed"}}catch(e){return console.error("bKash create payment error:",e),{success:!1,message:e.message||"bKash payment error"}}}async function i(e){try{let t=await s(),r=await fetch(`${o}/tokenized/checkout/execute`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",authorization:t,"x-app-key":process.env.BKASH_APP_KEY||""},body:JSON.stringify({paymentID:e})}),a=await r.json();if("0000"===a.statusCode&&"Completed"===a.transactionStatus)return{success:!0,transactionId:a.trxID,amount:parseFloat(a.amount),paymentID:a.paymentID,payerReference:a.payerReference,customerMsisdn:a.customerMsisdn,merchantInvoiceNumber:a.merchantInvoiceNumber};return{success:!1,message:a.statusMessage||"Payment execution failed"}}catch(e){return console.error("bKash execute payment error:",e),{success:!1,message:e.message||"bKash execution error"}}}},17820:(e,t,r)=>{r.d(t,{Z:()=>c});var o=r(6271),a=r(44020);let s=e=>new Date(e).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"}),n=e=>{if(!e)return"-";try{let t=JSON.parse(e);return`${t.size||""}${t.color?" / "+t.color:""}`.trim()||"-"}catch{return"-"}};function i(e,t,r,o,a){e.drawText(t,{x:r,y:o,size:a.size,font:a.font,color:a.color,maxWidth:a.maxWidth})}async function c(e){try{console.log("Generating PDF for order:",e);let t=await (0,a.Qc)(e);if(!t)return console.error("Order not found for PDF generation:",e),null;let r=await o.PDFDocument.create(),c=r.addPage([595,842]),{width:l,height:d}=c.getSize(),u=await r.embedFont(o.StandardFonts.Helvetica),p=await r.embedFont(o.StandardFonts.HelveticaBold),m=(0,o.rgb)(.11,.19,.33),h=(0,o.rgb)(.13,.13,.13),f=(0,o.rgb)(.47,.47,.47),y=(0,o.rgb)(.96,.96,.96),g=(0,o.rgb)(.16,.65,.53),b=(0,o.rgb)(1,1,1),k=d-50;c.drawRectangle({x:0,y:d-100,width:l,height:100,color:b}),i(c,"CTG",50,k-5,{font:p,size:24,color:m}),i(c,"Collection",105,k-5,{font:u,size:18,color:m}),i(c,"Premium Fashion & Lifestyle",50,k-22,{font:u,size:9,color:f}),i(c,"INVOICE",l-50-130,k,{font:u,size:9,color:f}),i(c,t.orderNumber,l-50-130,k-16,{font:p,size:14,color:m}),i(c,s(t.createdAt),l-50-130,k-32,{font:u,size:10,color:f}),k-=70,c.drawLine({start:{x:50,y:k},end:{x:l-50,y:k},thickness:1.5,color:m}),k-=35,i(c,"BILL TO",50,k,{font:p,size:9,color:f}),k-=16,i(c,t.address.name,50,k,{font:p,size:11,color:h}),k-=14,i(c,t.user?.email||t.guestEmail||"",50,k,{font:u,size:10,color:f}),k-=12,i(c,t.address.phone,50,k,{font:u,size:10,color:f});let x=k+42;for(let e of(i(c,"SHIP TO",l/2,x,{font:p,size:9,color:f}),x-=16,i(c,t.address.name,l/2,x,{font:p,size:11,color:h}),x-=14,i(c,t.address.address,l/2,x,{font:u,size:10,color:f,maxWidth:200}),x-=12,i(c,`${t.address.city}, ${t.address.district}`,l/2,x,{font:u,size:10,color:f}),k-=45,c.drawRectangle({x:50,y:k-8,width:l-100,height:24,color:y}),i(c,"ITEM",60,k,{font:p,size:9,color:f}),i(c,"VARIANT",220,k,{font:p,size:9,color:f}),i(c,"QTY",340,k,{font:p,size:9,color:f}),i(c,"PRICE",410,k,{font:p,size:9,color:f}),i(c,"TOTAL",490,k,{font:p,size:9,color:f}),k-=30,t.items)){i(c,e.product.name,60,k,{font:p,size:10,color:h});let t=n(e.variantInfo);i(c,t,220,k,{font:u,size:10,color:f}),i(c,e.quantity.toString(),340,k,{font:u,size:10,color:h}),i(c,`Tk${e.price.toLocaleString()}`,410,k,{font:u,size:10,color:h});let r=e.price*e.quantity;i(c,`Tk${r.toLocaleString()}`,490,k,{font:p,size:10,color:h}),k-=28,c.drawLine({start:{x:50,y:k+12},end:{x:l-50,y:k+12},thickness:.5,color:(0,o.rgb)(.9,.9,.9)})}k-=15,c.drawRectangle({x:50,y:k-80,width:l-100,height:90,color:y});let w=l-50-80;i(c,"Subtotal",70,k,{font:u,size:10,color:f}),i(c,`Tk${t.subtotal.toLocaleString()}`,w,k,{font:u,size:10,color:h}),k-=18,i(c,"Shipping",70,k,{font:u,size:10,color:f}),i(c,`Tk${t.shippingCost.toLocaleString()}`,w,k,{font:u,size:10,color:h}),k-=18,t.discount>0&&(i(c,"Discount",70,k,{font:u,size:10,color:g}),i(c,`-Tk${t.discount.toLocaleString()}`,w,k,{font:u,size:10,color:g}),k-=18),c.drawLine({start:{x:60,y:k+5},end:{x:l-50-10,y:k+5},thickness:1,color:(0,o.rgb)(.85,.85,.85)}),k-=8,i(c,"Total",70,k,{font:p,size:12,color:m}),i(c,`Tk${t.total.toLocaleString()}`,w-10,k,{font:p,size:14,color:m}),k-=40,c.drawRectangle({x:50,y:k-25,width:l-100,height:40,color:b,borderColor:(0,o.rgb)(.9,.9,.9),borderWidth:1});let z="cod"===t.paymentMethod?"Cash on Delivery":"Online Payment";if(i(c,`Payment: ${z}`,65,k-5,{font:p,size:10,color:h}),"paid"===t.paymentStatus){let e=l-50-70,t=k-12;c.drawRectangle({x:e,y:t,width:50,height:22,color:g,borderColor:g,borderWidth:1}),i(c,"Paid",e+12,t+6,{font:p,size:10,color:b})}k-=50,t.verificationCode&&(c.drawRectangle({x:50,y:k-25,width:l-100,height:40,color:y,borderColor:(0,o.rgb)(.9,.9,.9),borderWidth:1}),i(c,"Verification Code",65,k-5,{font:u,size:9,color:f}),i(c,t.verificationCode,l-50-80,k-5,{font:p,size:14,color:m})),c.drawRectangle({x:0,y:0,width:l,height:60,color:m}),i(c,"Thank you for shopping with CTG Collection! * ctgcollection2@gmail.com",100,32,{font:u,size:10,color:b});let S=await r.save();return console.log("PDF generated successfully, size:",S.length,"bytes"),Buffer.from(S)}catch(e){return console.error("Error generating PDF:",e),null}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,5245,6271,6119,4020],()=>r(72999));module.exports=o})();