"use strict";(()=>{var e={};e.id=4953,e.ids=[4953,7356],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},54563:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>k,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var s={};a.r(s),a.d(s,{POST:()=>l,dynamic:()=>u});var r=a(49303),n=a(88716),o=a(60670),c=a(87070),i=a(72331),p=a(66854);let u="force-dynamic";async function l(e){try{let{orderId:t,amount:a,phone:s}=await e.json();if(!t||!a)return c.NextResponse.json({error:"Order ID and amount required"},{status:400});if(!await i.prisma.order.findUnique({where:{id:t}}))return c.NextResponse.json({error:"Order not found"},{status:404});let r=await (0,p.j5)({orderId:t,amount:parseFloat(a),payerReference:s||"01991523289",callbackURL:"https://silkmartbd.com/api/payment/bkash/callback"});if(r.success)return await i.prisma.order.update({where:{id:t},data:{paymentId:r.paymentID,paymentMethod:"bkash"}}),c.NextResponse.json({success:!0,paymentID:r.paymentID,bkashURL:r.bkashURL,message:"Redirect customer to bKash"});return c.NextResponse.json({success:!1,error:r.message},{status:400})}catch(e){return console.error("bKash payment error:",e),c.NextResponse.json({error:e.message},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/payment/bkash/route",pathname:"/api/payment/bkash",filename:"route",bundlePath:"app/api/payment/bkash/route"},resolvedPagePath:"C:\\Users\\samia\\Desktop\\Learning Journey\\HostNin\\SilkMartWebSite\\app\\api\\payment\\bkash\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:y}=d,k="/api/payment/bkash/route";function b(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},66854:(e,t,a)=>{a.d(t,{A3:()=>c,j5:()=>o});let s="true"===process.env.BKASH_IS_SANDBOX?"https://tokenized.sandbox.bka.sh/v1.2.0-beta":"https://tokenized.pay.bka.sh/v1.2.0-beta",r=null;async function n(){if(r&&r.expiry>new Date)return r.token;let e=await fetch(`${s}/tokenized/checkout/token/grant`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",username:process.env.BKASH_USERNAME||"",password:process.env.BKASH_PASSWORD||""},body:JSON.stringify({app_key:process.env.BKASH_APP_KEY,app_secret:process.env.BKASH_APP_SECRET})}),t=await e.json();if("0000"===t.statusCode){let e=new Date;return e.setMinutes(e.getMinutes()+55),r={token:t.id_token,expiry:e},t.id_token}throw Error(t.statusMessage||"Failed to get bKash token")}async function o(e){try{let t=await n(),a=await fetch(`${s}/tokenized/checkout/create`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",authorization:t,"x-app-key":process.env.BKASH_APP_KEY||""},body:JSON.stringify({mode:"0011",payerReference:e.payerReference,callbackURL:e.callbackURL,amount:e.amount.toString(),currency:"BDT",intent:"sale",merchantInvoiceNumber:e.orderId})}),r=await a.json();if("0000"===r.statusCode)return{success:!0,paymentID:r.paymentID,bkashURL:r.bkashURL,callbackURL:r.callbackURL,successCallbackURL:r.successCallbackURL,failureCallbackURL:r.failureCallbackURL,cancelledCallbackURL:r.cancelledCallbackURL};return{success:!1,message:r.statusMessage||"Payment creation failed"}}catch(e){return console.error("bKash create payment error:",e),{success:!1,message:e.message||"bKash payment error"}}}async function c(e){try{let t=await n(),a=await fetch(`${s}/tokenized/checkout/execute`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",authorization:t,"x-app-key":process.env.BKASH_APP_KEY||""},body:JSON.stringify({paymentID:e})}),r=await a.json();if("0000"===r.statusCode&&"Completed"===r.transactionStatus)return{success:!0,transactionId:r.trxID,amount:parseFloat(r.amount),paymentID:r.paymentID,payerReference:r.payerReference,customerMsisdn:r.customerMsisdn,merchantInvoiceNumber:r.merchantInvoiceNumber};return{success:!1,message:r.statusMessage||"Payment execution failed"}}catch(e){return console.error("bKash execute payment error:",e),{success:!1,message:e.message||"bKash execution error"}}}},72331:(e,t,a)=>{a.d(t,{prisma:()=>n});var s=a(53524);let r=globalThis,n=r.prisma??new s.PrismaClient({log:["error"]});r.prisma=n}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[8948,5972],()=>a(54563));module.exports=s})();